<!DOCTYPE html>


  <html class="light page-post">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Binder: ServiceManager的创建 | Rouse</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="binder,">
  

  <meta name="description" content="&amp;#x627F;&amp;#x63A5;Binder: addService&amp;#x521D;&amp;#x63A2;&amp;#x8FD9;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#xFF0C;&amp;#x6211;&amp;#x4EEC;&amp;#x5DF2;&amp;#x7ECF;&amp;#x77E5;&amp;#x9053;Client&amp;#x7AEF;&amp;#x901A;&amp;#x8FC7;BpBinder&amp;#x7684;transact&amp;#x65B9;">
<meta name="keywords" content="binder">
<meta property="og:type" content="article">
<meta property="og:title" content="Binder: ServiceManager的创建">
<meta property="og:url" content="https://www.rousetime.com/2021/02/01/Binder-ServiceManager的创建/index.html">
<meta property="og:site_name" content="Rouse">
<meta property="og:description" content="&amp;#x627F;&amp;#x63A5;Binder: addService&amp;#x521D;&amp;#x63A2;&amp;#x8FD9;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#xFF0C;&amp;#x6211;&amp;#x4EEC;&amp;#x5DF2;&amp;#x7ECF;&amp;#x77E5;&amp;#x9053;Client&amp;#x7AEF;&amp;#x901A;&amp;#x8FC7;BpBinder&amp;#x7684;transact&amp;#x65B9;">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2022-12-01T14:19:08.589Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Binder: ServiceManager的创建">
<meta name="twitter:description" content="&amp;#x627F;&amp;#x63A5;Binder: addService&amp;#x521D;&amp;#x63A2;&amp;#x8FD9;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#xFF0C;&amp;#x6211;&amp;#x4EEC;&amp;#x5DF2;&amp;#x7ECF;&amp;#x77E5;&amp;#x9053;Client&amp;#x7AEF;&amp;#x901A;&amp;#x8FC7;BpBinder&amp;#x7684;transact&amp;#x65B9;">

  

  
  <!-- <link href="/favicon.ico" rel="icon" type="image/x-icon"> -->
    <link rel="icon" href="/favicon.ico">
    <!-- <link href="favicon.ico" rel="shortcut icon" type="image/x-icon" /> -->
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?bd7ea96a22c9c7b90353962460fa0b8e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>
</html>
<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            rel="noopener noreferrer"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceManager"><span class="toc-text">ServiceManager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main"><span class="toc-text">main</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#binder-open"><span class="toc-text">binder_open</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#binder-become-context-manager"><span class="toc-text">binder_become_context_manager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#binder-loop"><span class="toc-text">binder_loop</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#binder-write"><span class="toc-text">binder_write</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#binder-parse"><span class="toc-text">binder_parse</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#svcmgr-handler"><span class="toc-text">svcmgr_handler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#do-add-service"><span class="toc-text">do_add_service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#推荐"><span class="toc-text">推荐</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-Binder-ServiceManager的创建" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Binder: ServiceManager的创建</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2021.02.01</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Rouse</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/android/">android</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      

      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>&#x627F;&#x63A5;<a href="https://mp.weixin.qq.com/s?__biz=MzIzNTc5NDY4Nw==&amp;mid=2247485610&amp;idx=1&amp;sn=2ef38084699d2fcc5241a6cc57772751&amp;chksm=e8e0f13adf97782c65cb0b8204ad75d11e53b05ea361f66c01a5b352869aa7cf09fcd3168193&amp;token=963105090&amp;lang=zh_CN#rd" target="_blank" rel="noopener">Binder: addService&#x521D;&#x63A2;</a>&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;Client&#x7AEF;&#x901A;&#x8FC7;BpBinder&#x7684;transact&#x65B9;&#x6CD5;&#x4E0E;service&#x7AEF;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#xFF0C;&#x5728;BpBinder&#x7684;transact&#x65B9;&#x6CD5;&#x4E2D;&#x53C8;&#x901A;&#x8FC7;IPCThreadState&#x7684;transact&#x65B9;&#x6CD5;&#x5C06;&#x6570;&#x636E;&#x4F20;&#x9012;&#x5230;service&#x7AEF;&#x3002;</p>
<p>&#x6700;&#x7EC8;&#x6765;&#x5230;IPCThreadState&#x7684;writeTransactionData&#x65B9;&#x6CD5;</p>
<blockquote>
<p>frameworks/native/libs/binder/IPCThreadState.cpp</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">status_t IPCThreadState::writeTransactionData(int32_t cmd, uint32_t binderFlags,</span><br><span class="line">    int32_t handle, uint32_t code, const Parcel&amp; data, status_t* statusBuffer)</span><br><span class="line">{</span><br><span class="line">    binder_transaction_data tr;</span><br><span class="line"> </span><br><span class="line">    // &#x5C06;&#x6570;&#x636E;&#x5C01;&#x88C5;&#x5230;tr&#x4E2D;</span><br><span class="line">    tr.target.ptr = 0;</span><br><span class="line">    tr.target.handle = handle; // handle = 0, &#x5B9A;&#x4F4D;&#x5230;ServiceManager</span><br><span class="line">    tr.code = code; // &#x64CD;&#x4F5C;&#x7801; ADD_SERVICE_TRANSACTION</span><br><span class="line">    tr.flags = binderFlags;</span><br><span class="line">    tr.cookie = 0;</span><br><span class="line">    tr.sender_pid = 0;</span><br><span class="line">    tr.sender_euid = 0;</span><br><span class="line"> </span><br><span class="line">    const status_t err = data.errorCheck();</span><br><span class="line">    if (err == NO_ERROR) {</span><br><span class="line">        tr.data_size = data.ipcDataSize();</span><br><span class="line">        tr.data.ptr.buffer = data.ipcData();</span><br><span class="line">        tr.offsets_size = data.ipcObjectsCount()*sizeof(binder_size_t);</span><br><span class="line">        tr.data.ptr.offsets = data.ipcObjects();</span><br><span class="line">    } else if (statusBuffer) {</span><br><span class="line">        tr.flags |= TF_STATUS_CODE;</span><br><span class="line">        *statusBuffer = err;</span><br><span class="line">        tr.data_size = sizeof(status_t);</span><br><span class="line">        tr.data.ptr.buffer = reinterpret_cast&lt;uintptr_t&gt;(statusBuffer);</span><br><span class="line">        tr.offsets_size = 0;</span><br><span class="line">        tr.data.ptr.offsets = 0;</span><br><span class="line">    } else {</span><br><span class="line">        return (mLastError = err);</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    mOut.writeInt32(cmd); // &#x6307;&#x4EE4;&#x7801; BC_TRANSACTION</span><br><span class="line">    // &#x5199;&#x5165;&#x6570;&#x636E;&#xFF0C;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x4F20;&#x9012;</span><br><span class="line">    mOut.write(&amp;tr, sizeof(tr));</span><br><span class="line"> </span><br><span class="line">    return NO_ERROR;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;&#x4F20;&#x9012;&#x6570;&#x636E;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;handle = 0&#x6765;&#x5B9A;&#x4F4D;&#x5230;service&#x7684;service_manager&#x3002;</p>
<p>&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x5206;&#x6790;&#x4E00;&#x4E0B;ServiceManager&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x3002;</p>
<h2 id="ServiceManager"><a href="#ServiceManager" class="headerlink" title="ServiceManager"></a>ServiceManager</h2><p>ServiceManager&#x662F;&#x4F34;&#x968F;&#x7740;Android init &#x542F;&#x52A8;&#x4E00;&#x8D77;&#x88AB;&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x5728;init.rc&#x6587;&#x4EF6;&#x4E2D;&#x8FDB;&#x884C;&#x58F0;&#x660E;&#x7684;&#x3002;</p>
<p>&#x5176;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x53EF;&#x6267;&#x884C;&#x7A0B;&#x5E8F;&#x662F;/system/bin/servicemanager&#xFF0C;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x6E90;&#x6587;&#x4EF6;&#x662F;service_manager.c&#xFF0C;&#x8FDB;&#x7A0B;&#x540D;&#x4E3A;/system/bin/servicemanager&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">service servicemanager /system/bin/servicemanager</span><br><span class="line">    class core</span><br><span class="line">    user system</span><br><span class="line">    group system</span><br><span class="line">    critical</span><br><span class="line">    onrestart restart healthd</span><br><span class="line">    onrestart restart zygote</span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart surfaceflinger</span><br><span class="line">    onrestart restart drm</span><br></pre></td></tr></table></figure>
<p>&#x6240;&#x4EE5;&#x542F;&#x52A8;ServiceManager&#x7684;&#x5165;&#x53E3;&#x5728;service_manager.c&#x7684;main&#x65B9;&#x6CD5;&#x4E2D;</p>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><blockquote>
<p>frameworks/native/cmds/servicemanager/service_manager.c</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char** argv)</span><br><span class="line">{</span><br><span class="line">    struct binder_state *bs;</span><br><span class="line">    union selinux_callback cb;</span><br><span class="line">    char *driver;</span><br><span class="line"> </span><br><span class="line">    if (argc &gt; 1) {</span><br><span class="line">        driver = argv[1];</span><br><span class="line">    } else {</span><br><span class="line">        driver = &quot;/dev/binder&quot;;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    // &#x6253;&#x5F00;binder&#x9A71;&#x52A8;</span><br><span class="line">    bs = binder_open(driver, 128*1024);</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    // &#x5C06;ServiceManager&#x8BBE;&#x7F6E;&#x6210;binder&#x7684;&#x5B88;&#x62A4;&#x8005;</span><br><span class="line">    if (binder_become_context_manager(bs)) {</span><br><span class="line">        ALOGE(&quot;cannot become context manager (%s)\n&quot;, strerror(errno));</span><br><span class="line">        return -1;</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    // &#x5F00;&#x542F;binder&#x5FAA;&#x73AF;&#xFF0C;&#x76D1;&#x542C;&#x6570;&#x636E;&#x7684;&#x5230;&#x6765;</span><br><span class="line">    binder_loop(bs, svcmgr_handler);</span><br><span class="line">  </span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;main&#x65B9;&#x6CD5;&#x4E2D;&#x4E3B;&#x8981;&#x505A;&#x4E86;&#x4E09;&#x4EF6;&#x4E8B;</p>
<ol>
<li>&#x901A;&#x8FC7;binder_open&#x6253;&#x5F00;binder&#x9A71;&#x52A8;&#xFF0C;&#x7533;&#x8BF7;128kb&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x7A7A;&#x95F4;</li>
<li>&#x901A;&#x8FC7;binder_become_context_manager&#x5C06;ServiceManager&#x8BBE;&#x7F6E;&#x6210;binder&#x7684;&#x5B88;&#x62A4;&#x8005;</li>
<li>&#x901A;&#x8FC7;binder_loop&#x5F00;&#x542F;binder&#x5FAA;&#x73AF;&#xFF0C;&#x76D1;&#x542C;&#x6570;&#x636E;</li>
</ol>
<h2 id="binder-open"><a href="#binder-open" class="headerlink" title="binder_open"></a>binder_open</h2><blockquote>
<p>frameworks/native/cmds/servicemanager/binder.c</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">struct binder_state *binder_open(const char* driver, size_t mapsize)</span><br><span class="line">{</span><br><span class="line">    struct binder_state *bs;</span><br><span class="line">    struct binder_version vers;</span><br><span class="line"> </span><br><span class="line">    bs = malloc(sizeof(*bs));</span><br><span class="line">    if (!bs) {</span><br><span class="line">        errno = ENOMEM;</span><br><span class="line">        return NULL;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    // &#x5F00;&#x542F;binder&#x9A71;&#x52A8;</span><br><span class="line">    bs-&gt;fd = open(driver, O_RDWR | O_CLOEXEC);</span><br><span class="line">    if (bs-&gt;fd &lt; 0) {</span><br><span class="line">        fprintf(stderr,&quot;binder: cannot open %s (%s)\n&quot;,</span><br><span class="line">                driver, strerror(errno));</span><br><span class="line">        goto fail_open;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    // &#x83B7;&#x53D6;binder&#x7248;&#x672C;&#x4FE1;&#x606F;</span><br><span class="line">    if ((ioctl(bs-&gt;fd, BINDER_VERSION, &amp;vers) == -1) ||</span><br><span class="line">        (vers.protocol_version != BINDER_CURRENT_PROTOCOL_VERSION)) {</span><br><span class="line">        fprintf(stderr,</span><br><span class="line">                &quot;binder: kernel driver version (%d) differs from user space version (%d)\n&quot;,</span><br><span class="line">                vers.protocol_version, BINDER_CURRENT_PROTOCOL_VERSION);</span><br><span class="line">        goto fail_open;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    // &#x8BBE;&#x7F6E;mmap&#x6620;&#x5C04;&#x5927;&#x5C0F;128kb</span><br><span class="line">    bs-&gt;mapsize = mapsize;</span><br><span class="line">    // &#x8BBE;&#x7F6E;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x5730;&#x5740;</span><br><span class="line">    bs-&gt;mapped = mmap(NULL, mapsize, PROT_READ, MAP_PRIVATE, bs-&gt;fd, 0);</span><br><span class="line">    if (bs-&gt;mapped == MAP_FAILED) {</span><br><span class="line">        fprintf(stderr,&quot;binder: cannot map device (%s)\n&quot;,</span><br><span class="line">                strerror(errno));</span><br><span class="line">        goto fail_map;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    return bs;</span><br><span class="line"> </span><br><span class="line">fail_map:</span><br><span class="line">    close(bs-&gt;fd);</span><br><span class="line">fail_open:</span><br><span class="line">    free(bs);</span><br><span class="line">    return NULL;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x5BF9;bs&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x4E09;&#x4E2A;&#x53D8;&#x91CF;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#xFF0C;&#x5B83;&#x662F;binder_state&#x7C7B;&#x578B;&#x7684;&#x7ED3;&#x6784;&#x4F53;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct binder_state</span><br><span class="line">{</span><br><span class="line">    int fd; // dev/binder &#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;</span><br><span class="line">    void *mapped; // &#x6620;&#x5C04;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;</span><br><span class="line">    size_t mapsize; // &#x6620;&#x5C04;&#x7684;&#x5927;&#x5C0F;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>&#x6240;&#x4EE5;binder_open&#x4E3B;&#x8981;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#x662F;</p>
<ol>
<li>&#x6253;&#x5F00;binder&#x9A71;&#x52A8;</li>
<li>&#x9A8C;&#x8BC1;binder&#x7248;&#x672C;&#x4FE1;&#x606F;</li>
<li>&#x8BBE;&#x7F6E;mmap&#x5185;&#x5B58;&#x6620;&#x5C04;&#x5927;&#x5C0F;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;128kb</li>
<li>&#x8BBE;&#x7F6E;mmap&#x5185;&#x5B58;&#x6620;&#x5C04;&#x7684;&#x5730;&#x5740;</li>
</ol>
<h2 id="binder-become-context-manager"><a href="#binder-become-context-manager" class="headerlink" title="binder_become_context_manager"></a>binder_become_context_manager</h2><blockquote>
<p>frameworks/native/cmds/servicemanager/binder.c</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">int binder_become_context_manager(struct binder_state *bs)</span><br><span class="line">{</span><br><span class="line">    struct flat_binder_object obj;</span><br><span class="line">    // &#x521D;&#x59CB;&#x5316;obj</span><br><span class="line">    memset(&amp;obj, 0, sizeof(obj));</span><br><span class="line">    obj.flags = FLAT_BINDER_FLAG_TXN_SECURITY_CTX;</span><br><span class="line"> </span><br><span class="line">    // &#x4E0E;binder&#x9A71;&#x52A8;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x901A;&#x4FE1;</span><br><span class="line">    int result = ioctl(bs-&gt;fd, BINDER_SET_CONTEXT_MGR_EXT, &amp;obj);</span><br><span class="line"> </span><br><span class="line">    if (result != 0) {</span><br><span class="line">        android_errorWriteLog(0x534e4554, &quot;121035042&quot;);</span><br><span class="line"> </span><br><span class="line">        // &#x4E0E;binder&#x9A71;&#x52A8;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x901A;&#x4FE1;</span><br><span class="line">        result = ioctl(bs-&gt;fd, BINDER_SET_CONTEXT_MGR, 0);</span><br><span class="line">    }</span><br><span class="line">    return result;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;binder_become_context_manager&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x901A;&#x8FC7;ioctl&#x4E0E;binder&#x9A71;&#x52A8;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#xFF0C;&#x5E76;&#x4F20;&#x5165;&#x6570;&#x636E;0&#x4F5C;&#x4E3A;&#x6807;&#x8BC6;&#xFF0C;&#x5C06;ServiceManager&#x8BBE;&#x7F6E;&#x4E3A;binder&#x7684;&#x5B88;&#x62A4;&#x8005;&#xFF0C;&#x7528;&#x6765;&#x7EDF;&#x4E00;&#x5904;&#x7406;binder&#x7684;&#x6570;&#x636E;&#x4F20;&#x8F93;&#x3002;</p>
<h2 id="binder-loop"><a href="#binder-loop" class="headerlink" title="binder_loop"></a>binder_loop</h2><blockquote>
<p>frameworks/native/cmds/servicemanager/binder.c</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">void binder_loop(struct binder_state *bs, binder_handler func)</span><br><span class="line">{</span><br><span class="line">  int res;</span><br><span class="line">  struct binder_write_read bwr;</span><br><span class="line">  uint32_t readbuf[32];</span><br><span class="line"> </span><br><span class="line">  bwr.write_size = 0;</span><br><span class="line">  bwr.write_consumed = 0;</span><br><span class="line">  bwr.write_buffer = 0;</span><br><span class="line"> </span><br><span class="line">  readbuf[0] = BC_ENTER_LOOPER;</span><br><span class="line">  // &#x5199;&#x5165;&#x6570;&#x636E;</span><br><span class="line">  binder_write(bs, readbuf, sizeof(uint32_t));</span><br><span class="line"> </span><br><span class="line">  // &#x5F00;&#x542F;&#x5FAA;&#x73AF;&#xFF0C;&#x76D1;&#x542C;&#x6570;&#x636E;&#x7684;&#x5230;&#x6765;</span><br><span class="line">  for (;;) {</span><br><span class="line">      bwr.read_size = sizeof(readbuf);</span><br><span class="line">      bwr.read_consumed = 0;</span><br><span class="line">      bwr.read_buffer = (uintptr_t) readbuf;</span><br><span class="line"> </span><br><span class="line">      // &#x83B7;&#x53D6;binder&#x9A71;&#x52A8;&#x4E2D;&#x7684;&#x6570;&#x636E;</span><br><span class="line">      res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line"> </span><br><span class="line">      if (res &lt; 0) {</span><br><span class="line">          ALOGE(&quot;binder_loop: ioctl failed (%s)\n&quot;, strerror(errno));</span><br><span class="line">          break;</span><br><span class="line">      }</span><br><span class="line"> </span><br><span class="line">      // &#x89E3;&#x6790;&#x6570;&#x636E;</span><br><span class="line">      res = binder_parse(bs, 0, (uintptr_t) readbuf, bwr.read_consumed, func);</span><br><span class="line">      if (res == 0) {</span><br><span class="line">          ALOGE(&quot;binder_loop: unexpected reply?!\n&quot;);</span><br><span class="line">          break;</span><br><span class="line">      }</span><br><span class="line">      if (res &lt; 0) {</span><br><span class="line">          ALOGE(&quot;binder_loop: io error %d %s\n&quot;, res, strerror(errno));</span><br><span class="line">          break;</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;binder_loop&#x4E2D;&#x4E3B;&#x8981;&#x505A;&#x4E86;&#x4E09;&#x4EF6;&#x4E8B;&#xFF1A;</p>
<ol>
<li>&#x9996;&#x5148;&#x901A;&#x8FC7;binder_write&#x4F20;&#x9012;BC_ENTER_LOOPER&#x6307;&#x4EE4;&#x7801;&#xFF0C;&#x544A;&#x8BC9;binder&#x8FDB;&#x5165;&#x5FAA;&#x73AF;</li>
<li>&#x5F00;&#x542F;&#x5FAA;&#x5E8F;&#xFF0C;&#x901A;&#x8FC7;ioctl&#x76D1;&#x542C;&#x5E76;&#x8BFB;&#x53D6;&#x6570;&#x636E;</li>
<li>&#x4E00;&#x65E6;&#x8BFB;&#x53D6;&#x5230;&#x6570;&#x636E;&#xFF0C;&#x5C06;&#x901A;&#x8FC7;binder_parse&#x6765;&#x8FDB;&#x4E00;&#x6B65;&#x89E3;&#x6790;</li>
</ol>
<h3 id="binder-write"><a href="#binder-write" class="headerlink" title="binder_write"></a>binder_write</h3><blockquote>
<p>frameworks/native/cmds/servicemanager/binder.c</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">int binder_write(struct binder_state *bs, void *data, size_t len)</span><br><span class="line">{</span><br><span class="line">  struct binder_write_read bwr;</span><br><span class="line">  int res;</span><br><span class="line"> </span><br><span class="line">  // &#x5C06;&#x6570;&#x636E;&#x586B;&#x5145;&#x5230;bwr&#x4E2D;</span><br><span class="line">  bwr.write_size = len;</span><br><span class="line">  bwr.write_consumed = 0;</span><br><span class="line">  bwr.write_buffer = (uintptr_t) data;</span><br><span class="line">  bwr.read_size = 0;</span><br><span class="line">  bwr.read_consumed = 0;</span><br><span class="line">  bwr.read_buffer = 0;</span><br><span class="line">  // &#x4F20;&#x8F93;&#x6570;&#x636E;</span><br><span class="line">  res = ioctl(bs-&gt;fd, BINDER_WRITE_READ, &amp;bwr);</span><br><span class="line">  if (res &lt; 0) {</span><br><span class="line">      fprintf(stderr,&quot;binder_write: ioctl failed (%s)\n&quot;,</span><br><span class="line">              strerror(errno));</span><br><span class="line">  }</span><br><span class="line">  return res;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x662F;&#x5C06;&#x6570;&#x636E;&#x7EDF;&#x4E00;&#x5C01;&#x88C5;&#x5230;bwr&#x4E2D;&#xFF0C;bwr&#x662F;binder_write_read&#x7684;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5F53;&#x5199;&#x6570;&#x636E;&#x65F6;&#x4F1A;&#x5C06;&#x6570;&#x636E;&#x5199;&#x5165;&#x5230;write_buffer&#x4E2D;&#xFF0C;&#x800C;&#x5F53;&#x8BFB;&#x6570;&#x636E;&#x65F6;&#x4F1A;&#x4ECE;read_buffer&#x4E2D;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x652F;&#x6301;&#x53CC;&#x5411;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#x7684;&#x6570;&#x636E;&#x6E90;&#x3002;&#x4EE5;&#x4FBF;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;ioctl&#x4E0E;binder&#x9A71;&#x52A8;&#x8FDB;&#x884C;&#x8BFB;&#x5199;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x662F;&#x9996;&#x6B21;&#x8FDB;&#x5165;&#x4E14;&#x5373;&#x5C06;&#x8FDB;&#x5165;&#x5FAA;&#x5E8F;&#x64CD;&#x4F5C;&#xFF0C;&#x6240;&#x4EE5;&#x7B2C;&#x4E00;&#x6B21;&#x4F1A;&#x4F20;&#x9012;BC_ENTER_LOOPER&#x6307;&#x4EE4;&#x7801;&#xFF0C;&#x901A;&#x77E5;binder&#x8FDB;&#x884C;&#x5FAA;&#x73AF;&#x64CD;&#x4F5C;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x901A;&#x8FC7;ioctl&#x53D1;&#x9001;BINDER_WRITE_READ&#x7684;&#x901A;&#x4FE1;code&#xFF0C;&#x5C06;bwr&#x4F20;&#x9012;&#x7ED9;binder&#x9A71;&#x52A8;&#x3002;</p>
<h3 id="binder-parse"><a href="#binder-parse" class="headerlink" title="binder_parse"></a>binder_parse</h3><blockquote>
<p>frameworks/native/cmds/servicemanager/binder.c</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">int binder_parse(struct binder_state *bs, struct binder_io *bio,</span><br><span class="line">               uintptr_t ptr, size_t size, binder_handler func)</span><br><span class="line">{</span><br><span class="line">  int r = 1;</span><br><span class="line">  // &#x83B7;&#x53D6;&#x6570;&#x636E;&#x622A;&#x6B62;&#x4F4D;&#x7684;&#x5185;&#x5B58;&#x5730;&#x5740;</span><br><span class="line">  uintptr_t end = ptr + (uintptr_t) size;</span><br><span class="line">  while (ptr &lt; end) {</span><br><span class="line">      uint32_t cmd = *(uint32_t *) ptr;</span><br><span class="line">      ptr += sizeof(uint32_t);</span><br><span class="line">      switch(cmd) {</span><br><span class="line"> </span><br><span class="line">      ...</span><br><span class="line"> </span><br><span class="line">      case BR_TRANSACTION: {</span><br><span class="line">          struct binder_transaction_data_secctx txn;</span><br><span class="line"> </span><br><span class="line">          ...</span><br><span class="line"> </span><br><span class="line">          if (func) {</span><br><span class="line">              unsigned rdata[256/4];</span><br><span class="line">              struct binder_io msg;</span><br><span class="line">              struct binder_io reply;</span><br><span class="line">              int res;</span><br><span class="line"> </span><br><span class="line">              bio_init(&amp;reply, rdata, sizeof(rdata), 4);</span><br><span class="line">              bio_init_from_txn(&amp;msg, &amp;txn.transaction_data);</span><br><span class="line"> </span><br><span class="line">              // &#x8C03;&#x7528;func&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x662F;svcmgr_handler</span><br><span class="line">              res = func(bs, &amp;txn, &amp;msg, &amp;reply);</span><br><span class="line">              if (txn.transaction_data.flags &amp; TF_ONE_WAY) {</span><br><span class="line">                  binder_free_buffer(bs, txn.transaction_data.data.ptr.buffer);</span><br><span class="line">              } else {</span><br><span class="line">                  // &#x53D1;&#x9001;reply</span><br><span class="line">                  binder_send_reply(bs, &amp;reply, txn.transaction_data.data.ptr.buffer, res);</span><br><span class="line">              }</span><br><span class="line">          }</span><br><span class="line">          break;</span><br><span class="line">      }</span><br><span class="line"> </span><br><span class="line">      ...</span><br><span class="line"> </span><br><span class="line">      case BR_REPLY: {</span><br><span class="line"> </span><br><span class="line">          ...</span><br><span class="line"> </span><br><span class="line">          break;</span><br><span class="line">      }</span><br><span class="line">      default:</span><br><span class="line">          ALOGE(&quot;parse: OOPS %d\n&quot;, cmd);</span><br><span class="line">          return -1;</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line"> </span><br><span class="line">  return r;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>binder_parse&#x4E2D;&#x4E3B;&#x8981;&#x662F;&#x89E3;&#x6790;binder&#x4FE1;&#x606F;&#xFF0C;&#x53C2;&#x6570;ptr&#x6307;&#x5411;BC_ENTER_LOOPER&#xFF0C;func&#x6307;&#x5411;svcmgr_handler&#x3002;&#x6240;&#x4EE5;&#x4E00;&#x65E6;&#x8BF7;&#x6C42;&#x5230;&#x6765;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;svcmgr_handler&#xFF0C;&#x5E76;&#x5C06;&#x5904;&#x7406;&#x7684;&#x7ED3;&#x6784;&#x901A;&#x8FC7;binder_send_reply&#x8FD4;&#x56DE;&#x4F1A;&#x7ED9;client&#x7AEF;&#x3002;&#x8FD9;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;&#x5C31;&#x662F;&#x4E4B;&#x524D;&#x6587;&#x7AE0;&#x4E2D;&#x8BF4;&#x7684;BC_REPLAY&#x3002;</p>
<p>&#x8FD9;&#x4E2A;svcmgr_handler&#x662F;&#x5728;&#x6700;&#x5916;&#x9762;&#x7684;binder_loop&#x4F20;&#x9012;&#x8FC7;&#x6765;&#x7684;&#x3002;</p>
<h3 id="svcmgr-handler"><a href="#svcmgr-handler" class="headerlink" title="svcmgr_handler"></a>svcmgr_handler</h3><blockquote>
<p>frameworks/native/cmds/servicemanager/service_manager.c</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">int svcmgr_handler(struct binder_state *bs,</span><br><span class="line">                   struct binder_transaction_data_secctx *txn_secctx,</span><br><span class="line">                   struct binder_io *msg,</span><br><span class="line">                   struct binder_io *reply)</span><br><span class="line">{</span><br><span class="line">    struct svcinfo *si;</span><br><span class="line">    uint16_t *s;</span><br><span class="line">    size_t len;</span><br><span class="line">    uint32_t handle;</span><br><span class="line">    uint32_t strict_policy;</span><br><span class="line">    int allow_isolated;</span><br><span class="line">    uint32_t dumpsys_priority;</span><br><span class="line"> </span><br><span class="line">    struct binder_transaction_data *txn = &amp;txn_secctx-&gt;transaction_data;</span><br><span class="line"> </span><br><span class="line">    switch(txn-&gt;code) {</span><br><span class="line">    case SVC_MGR_GET_SERVICE:</span><br><span class="line">    case SVC_MGR_CHECK_SERVICE:</span><br><span class="line">        s = bio_get_string16(msg, &amp;len);</span><br><span class="line">        if (s == NULL) {</span><br><span class="line">            return -1;</span><br><span class="line">        }</span><br><span class="line">        // &#x67E5;&#x627E;service</span><br><span class="line">        handle = do_find_service(s, len, txn-&gt;sender_euid, txn-&gt;sender_pid,</span><br><span class="line">                                 (const char*) txn_secctx-&gt;secctx);</span><br><span class="line">        if (!handle)</span><br><span class="line">            break;</span><br><span class="line">        bio_put_ref(reply, handle);</span><br><span class="line">        return 0;</span><br><span class="line"> </span><br><span class="line">    case SVC_MGR_ADD_SERVICE:</span><br><span class="line">        s = bio_get_string16(msg, &amp;len);</span><br><span class="line">        if (s == NULL) {</span><br><span class="line">            return -1;</span><br><span class="line">        }</span><br><span class="line">        handle = bio_get_ref(msg);</span><br><span class="line">        allow_isolated = bio_get_uint32(msg) ? 1 : 0;</span><br><span class="line">        dumpsys_priority = bio_get_uint32(msg);</span><br><span class="line"> </span><br><span class="line">        // &#x6CE8;&#x518C;service</span><br><span class="line">        if (do_add_service(bs, s, len, handle, txn-&gt;sender_euid, allow_isolated, dumpsys_priority,</span><br><span class="line">                           txn-&gt;sender_pid, (const char*) txn_secctx-&gt;secctx))</span><br><span class="line">            return -1;</span><br><span class="line">        break;</span><br><span class="line">    case SVC_MGR_LIST_SERVICES: {</span><br><span class="line">        uint32_t n = bio_get_uint32(msg);</span><br><span class="line">        uint32_t req_dumpsys_priority = bio_get_uint32(msg);</span><br><span class="line">        if (!svc_can_list(txn-&gt;sender_pid, (const char*) txn_secctx-&gt;secctx, txn-&gt;sender_euid)) {</span><br><span class="line">            ALOGE(&quot;list_service() uid=%d - PERMISSION DENIED\n&quot;,</span><br><span class="line">                    txn-&gt;sender_euid);</span><br><span class="line">            return -1;</span><br><span class="line">        }</span><br><span class="line">        si = svclist;</span><br><span class="line"> </span><br><span class="line">        // &#x904D;&#x5386;service</span><br><span class="line">        while (si) {</span><br><span class="line">            if (si-&gt;dumpsys_priority &amp; req_dumpsys_priority) {</span><br><span class="line">                if (n == 0) break;</span><br><span class="line">                n--;</span><br><span class="line">            }</span><br><span class="line">            si = si-&gt;next;</span><br><span class="line">        }</span><br><span class="line">        if (si) {</span><br><span class="line">            bio_put_string16(reply, si-&gt;name);</span><br><span class="line">            return 0;</span><br><span class="line">        }</span><br><span class="line">        return -1;</span><br><span class="line">    }</span><br><span class="line">    default:</span><br><span class="line">        ALOGE(&quot;unknown code %d\n&quot;, txn-&gt;code);</span><br><span class="line">        return -1;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    bio_put_uint32(reply, 0);</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>svcmgr_handler&#x4E3B;&#x8981;&#x662F;&#x5BF9;service&#x7684;&#x64CD;&#x4F5C;&#x5904;&#x7406;&#xFF0C;&#x4F8B;&#x5982;&#x4E4B;&#x524D;&#x6587;&#x7AE0;&#x4E2D;&#x63D0;&#x5230;&#x7684;addService&#x64CD;&#x4F5C;&#xFF0C;&#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x5728;SVC_MGR_ADD_SERVICE&#x4E2D;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;</p>
<p>&#x5728;SVC_MGR_ADD_SERVICE&#x4E2D;&#x4F1A;&#x901A;&#x8FC7;do_add_service&#x65B9;&#x6CD5;&#x6765;&#x6CE8;&#x518C;service&#x3002;</p>
<h3 id="do-add-service"><a href="#do-add-service" class="headerlink" title="do_add_service"></a>do_add_service</h3><blockquote>
<p>frameworks/native/cmds/servicemanager/service_manager.c</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">int do_add_service(struct binder_state *bs, const uint16_t *s, size_t len, uint32_t handle,</span><br><span class="line">                   uid_t uid, int allow_isolated, uint32_t dumpsys_priority, pid_t spid, const char* sid) {</span><br><span class="line">    struct svcinfo *si;</span><br><span class="line"> </span><br><span class="line">    if (!handle || (len == 0) || (len &gt; 127))</span><br><span class="line">        return -1;</span><br><span class="line"> </span><br><span class="line">    // &#x68C0;&#x67E5;&#x662F;&#x5426;&#x80FD;&#x591F;&#x6CE8;&#x518C;&#x8BE5;service</span><br><span class="line">    if (!svc_can_register(s, len, spid, sid, uid)) {</span><br><span class="line">        ALOGE(&quot;add_service(&apos;%s&apos;,%x) uid=%d - PERMISSION DENIED\n&quot;,</span><br><span class="line">             str8(s, len), handle, uid);</span><br><span class="line">        return -1;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    // &#x67E5;&#x627E;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x6CE8;&#x518C;&#x4E86;</span><br><span class="line">    si = find_svc(s, len);</span><br><span class="line">    if (si) { //&#x5DF2;&#x7ECF;&#x6CE8;&#x518C;</span><br><span class="line">        if (si-&gt;handle) {</span><br><span class="line">            ALOGE(&quot;add_service(&apos;%s&apos;,%x) uid=%d - ALREADY REGISTERED, OVERRIDE\n&quot;,</span><br><span class="line">                 str8(s, len), handle, uid);</span><br><span class="line">            svcinfo_death(bs, si);</span><br><span class="line">        }</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">    } else { //&#x6CA1;&#x6709;&#x6CE8;&#x518C;</span><br><span class="line">        // &#x7533;&#x8BF7;&#x5185;&#x5B58;</span><br><span class="line">        si = malloc(sizeof(*si) + (len + 1) * sizeof(uint16_t));</span><br><span class="line">        if (!si) {</span><br><span class="line">            ALOGE(&quot;add_service(&apos;%s&apos;,%x) uid=%d - OUT OF MEMORY\n&quot;,</span><br><span class="line">                 str8(s, len), handle, uid);</span><br><span class="line">            return -1;</span><br><span class="line">        }</span><br><span class="line">        si-&gt;handle = handle;</span><br><span class="line">        si-&gt;len = len;</span><br><span class="line">        memcpy(si-&gt;name, s, (len + 1) * sizeof(uint16_t));</span><br><span class="line">        si-&gt;name[len] = &apos;\0&apos;;</span><br><span class="line">        si-&gt;death.func = (void*) svcinfo_death;</span><br><span class="line">        si-&gt;death.ptr = si;</span><br><span class="line">        si-&gt;allow_isolated = allow_isolated;</span><br><span class="line">        si-&gt;dumpsys_priority = dumpsys_priority;</span><br><span class="line">        si-&gt;next = svclist;</span><br><span class="line">        // &#x4FDD;&#x5B58;&#x5230;svclist&#x8868;&#x4E2D;</span><br><span class="line">        svclist = si;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    binder_acquire(bs, handle);</span><br><span class="line">    binder_link_to_death(bs, handle, &amp;si-&gt;death);</span><br><span class="line">    return 0;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x5728;do_add_service&#x4E2D;&#x9996;&#x5148;&#x4F1A;&#x68C0;&#x67E5;&#x8BE5;&#x6CE8;&#x518C;&#x7684;service&#x662F;&#x5426;&#x80FD;&#x591F;&#x6CE8;&#x518C;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x51FA;&#x67E5;&#x8BE2;&#x73B0;&#x6709;&#x7684;svclist&#x4E2D;&#x662F;&#x5426;&#x5B58;&#x5728;&#x8BE5;service&#xFF1B;&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x5C31;&#x4E3A;&#x8BE5;service&#x7533;&#x8BF7;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x6700;&#x540E;&#x5728;&#x52A0;&#x5165;&#x5230;svclist&#x6CE8;&#x518C;&#x8868;&#x4E2D;&#x3002;</p>
<p>&#x81F3;&#x6B64;&#x6574;&#x4E2A;ServiceManager&#x7684;&#x6D41;&#x7A0B;&#x5C31;&#x5206;&#x6790;&#x5B8C;&#x4E86;&#xFF0C;&#x6211;&#x8FD9;&#x91CC;&#x505A;&#x4E2A;&#x603B;&#x7ED3;&#xFF1A;</p>
<ol>
<li>&#x901A;&#x8FC7;binder_open&#x6253;&#x5F00;binder&#x9A71;&#x52A8;&#xFF0C;&#x5E76;&#x8C03;&#x7528;mmap&#x5206;&#x914D;128kb&#x7684;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x5730;&#x5740;&#x7A7A;&#x95F4;</li>
<li>&#x901A;&#x8FC7;binder_become_context_manager&#x5C06;ServiceManager&#x8BBE;&#x7F6E;&#x4E3A;binder&#x9A71;&#x52A8;&#x7684;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#xFF0C;&#x901A;&#x8FC7;0&#x6765;&#x6807;&#x8BC6;</li>
<li>&#x901A;&#x8FC7;binder_loop&#x5F00;&#x542F;&#x5FAA;&#x73AF;&#xFF0C;&#x7B49;&#x5F85;&#x4E0E;&#x76D1;&#x542C;client&#x7AEF;&#x4F20;&#x9012;&#x8FC7;&#x6765;&#x7684;&#x6570;&#x636E;</li>
<li>&#x5728;&#x6570;&#x636E;&#x76D1;&#x542C;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F7F;&#x7528;binder_write&#x901A;&#x77E5;binder&#x8FDB;&#x884C;&#x5FAA;&#x73AF;</li>
<li>&#x901A;&#x8FC7;ioctl&#x6765;&#x4E0E;binder&#x9A71;&#x52A8;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x8BFB;&#x5199;</li>
<li>&#x901A;&#x8FC7;binder_parse&#x6765;&#x89E3;&#x6790;&#x76D1;&#x542C;&#x5230;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x6839;&#x636E;BR_&#x6307;&#x4EE4;&#x7801;&#x6765;&#x533A;&#x522B;&#x4E0D;&#x540C;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;reply&#x4E0E;BC_&#x6307;&#x4EE4;&#x7801;&#x7684;&#x65B9;&#x5F0F;&#x56DE;&#x9988;&#x7ED9;client&#x7AEF;</li>
<li>&#x5C06;&#x89E3;&#x6790;&#x7684;&#x6570;&#x636E;&#x56DE;&#x8C03;&#x7ED9;svcmgr_handler&#x8FDB;&#x884C;&#x7EDF;&#x4E00;&#x903B;&#x8F91;&#x5904;&#x7406;&#xFF0C;&#x5305;&#x62EC;service&#x7684;&#x6CE8;&#x518C;&#x3001;&#x67E5;&#x627E;&#x3001;&#x9A8C;&#x8BC1;&#x7B49;&#x64CD;&#x4F5C;</li>
<li>&#x6700;&#x7EC8;ServiceManager&#x4F1A;&#x5C06;&#x6CE8;&#x518C;&#x7684;service&#x4FDD;&#x5B58;&#x5230;svclist&#x6CE8;&#x518C;&#x8868;&#x4E2D;&#xFF0C;&#x4EE5;&#x4FBF;&#x4E4B;&#x540E;&#x7684;&#x9A8C;&#x8BC1;&#x4E0E;&#x67E5;&#x8BE2;</li>
</ol>
<h2 id="&#x63A8;&#x8350;"><a href="#&#x63A8;&#x8350;" class="headerlink" title="&#x63A8;&#x8350;"></a>&#x63A8;&#x8350;</h2><p><a href="https://github.com/idisfkj/android-startup" target="_blank" rel="noopener">android_startup</a>: &#x63D0;&#x4F9B;&#x4E00;&#x79CD;&#x5728;&#x5E94;&#x7528;&#x542F;&#x52A8;&#x65F6;&#x80FD;&#x591F;&#x66F4;&#x52A0;&#x7B80;&#x5355;&#x3001;&#x9AD8;&#x6548;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x521D;&#x59CB;&#x5316;&#x7EC4;&#x4EF6;&#xFF0C;&#x4F18;&#x5316;&#x542F;&#x52A8;&#x901F;&#x5EA6;&#x3002;&#x4E0D;&#x4EC5;&#x652F;&#x6301;Jetpack App Startup&#x7684;&#x5168;&#x90E8;&#x529F;&#x80FD;&#xFF0C;&#x8FD8;&#x63D0;&#x4F9B;&#x989D;&#x5916;&#x7684;&#x540C;&#x6B65;&#x4E0E;&#x5F02;&#x6B65;&#x7B49;&#x5F85;&#x3001;&#x7EBF;&#x7A0B;&#x63A7;&#x5236;&#x4E0E;&#x591A;&#x8FDB;&#x7A0B;&#x652F;&#x6301;&#x7B49;&#x529F;&#x80FD;&#x3002;</p>
<p><a href="https://github.com/idisfkj/AwesomeGithub" target="_blank" rel="noopener">AwesomeGithub</a>: &#x57FA;&#x4E8E;Github&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x7EAF;&#x7EC3;&#x4E60;&#x9879;&#x76EE;&#xFF0C;&#x652F;&#x6301;&#x7EC4;&#x4EF6;&#x5316;&#x5F00;&#x53D1;&#xFF0C;&#x652F;&#x6301;&#x8D26;&#x6237;&#x5BC6;&#x7801;&#x4E0E;&#x8BA4;&#x8BC1;&#x767B;&#x9646;&#x3002;&#x4F7F;&#x7528;Kotlin&#x8BED;&#x8A00;&#x8FDB;&#x884C;&#x5F00;&#x53D1;&#xFF0C;&#x9879;&#x76EE;&#x67B6;&#x6784;&#x662F;&#x57FA;&#x4E8E;JetPack&amp;DataBinding&#x7684;MVVM&#xFF1B;&#x9879;&#x76EE;&#x4E2D;&#x4F7F;&#x7528;&#x4E86;Arouter&#x3001;Retrofit&#x3001;Coroutine&#x3001;Glide&#x3001;Dagger&#x4E0E;Hilt&#x7B49;&#x6D41;&#x884C;&#x5F00;&#x6E90;&#x6280;&#x672F;&#x3002;</p>
<p><a href="https://github.com/idisfkj/flutter_github" target="_blank" rel="noopener">flutter_github</a>: &#x57FA;&#x4E8E;Flutter&#x7684;&#x8DE8;&#x5E73;&#x53F0;&#x7248;&#x672C;Github&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x4E0E;AwesomeGithub&#x76F8;&#x5BF9;&#x5E94;&#x3002;</p>
<p><a href="https://github.com/idisfkj/android-api-analysis" target="_blank" rel="noopener">android-api-analysis</a>: &#x7ED3;&#x5408;&#x8BE6;&#x7EC6;&#x7684;Demo&#x6765;&#x5168;&#x9762;&#x89E3;&#x6790;Android&#x76F8;&#x5173;&#x7684;&#x77E5;&#x8BC6;&#x70B9;, &#x5E2E;&#x52A9;&#x8BFB;&#x8005;&#x80FD;&#x591F;&#x66F4;&#x5FEB;&#x7684;&#x638C;&#x63E1;&#x4E0E;&#x7406;&#x89E3;&#x6240;&#x9610;&#x8FF0;&#x7684;&#x8981;&#x70B9;&#x3002;</p>
<p><a href="https://github.com/idisfkj/daily_algorithm" target="_blank" rel="noopener">daily_algorithm</a>: &#x6BCF;&#x65E5;&#x4E00;&#x7B97;&#x6CD5;&#xFF0C;&#x7531;&#x6D45;&#x5165;&#x6DF1;&#xFF0C;&#x6B22;&#x8FCE;&#x52A0;&#x5165;&#x4E00;&#x8D77;&#x5171;&#x52C9;&#x3002;</p>

    
  </div>
</article>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">赞赏是一门艺术</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/images/rouse_wechat.png" alt="">
          </li>
        
          <li class="item">
            <img src="/images/rouse_alipay.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2021/01/26/Binder-addService初探/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2021/05/28/为了能够摸鱼，我走上了歧路/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              rel="noopener noreferrer"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
    <div class="fexo-comments comments-post">
  

  

  

  
  <div id="gitment-comments"></div>
  <link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
  <script src="https://jjeejj.github.io/js/gitment.js"></script>
  <script>
    (function () {
      var gitment = new Gitment({
        owner: 'idisfkj',
        repo: 'idisfkj.github.io',
        id: 'Mon Feb 01 2021 22:10:28 GMT+0800',
        oauth: {
          client_id: 'dafb1df02ea9f875bb78',
          client_secret: 'e9873d78aa5eaed5ce61d1d865a5af501dae377a'
        },
        
        
        
        
        
        
        
        
      })
      gitment.render('gitment-comments')
    })()
  </script>

  
  
</div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
