<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>Fresco源码分析之Producer | Idisfkj</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="源码分析," />
  

  <meta name="description" content="Fresco&amp;#x6709;&amp;#x4E09;&amp;#x7EA7;&amp;#x7F13;&amp;#x5B58;&amp;#xFF0C;&amp;#x5206;&amp;#x522B;&amp;#x4E3A;Bitmap&amp;#x7F13;&amp;#x5B58;&amp;#x3001;&amp;#x672A;&amp;#x89E3;&amp;#x7801;&amp;#x56FE;&amp;#x7247;&amp;#x7684;&amp;#x5185;&amp;#x5B58;&amp;#x7F13;&amp;#x5B58;&amp;#x4E0E;&amp;#x7">
<meta property="og:type" content="article">
<meta property="og:title" content="Fresco源码分析之Producer">
<meta property="og:url" content="https://www.rousetime.com/2017/12/28/Fresco源码分析之Producer/index.html">
<meta property="og:site_name" content="Idisfkj">
<meta property="og:description" content="Fresco&amp;#x6709;&amp;#x4E09;&amp;#x7EA7;&amp;#x7F13;&amp;#x5B58;&amp;#xFF0C;&amp;#x5206;&amp;#x522B;&amp;#x4E3A;Bitmap&amp;#x7F13;&amp;#x5B58;&amp;#x3001;&amp;#x672A;&amp;#x89E3;&amp;#x7801;&amp;#x56FE;&amp;#x7247;&amp;#x7684;&amp;#x5185;&amp;#x5B58;&amp;#x7F13;&amp;#x5B58;&amp;#x4E0E;&amp;#x7">
<meta property="og:updated_time" content="2018-03-29T00:45:34.354Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fresco源码分析之Producer">
<meta name="twitter:description" content="Fresco&amp;#x6709;&amp;#x4E09;&amp;#x7EA7;&amp;#x7F13;&amp;#x5B58;&amp;#xFF0C;&amp;#x5206;&amp;#x522B;&amp;#x4E3A;Bitmap&amp;#x7F13;&amp;#x5B58;&amp;#x3001;&amp;#x672A;&amp;#x89E3;&amp;#x7801;&amp;#x56FE;&amp;#x7247;&amp;#x7684;&amp;#x5185;&amp;#x5B58;&amp;#x7F13;&amp;#x5B58;&amp;#x4E0E;&amp;#x7">

  

  
  <!-- <link href="/favicon.ico" rel="icon" type="image/x-icon"> -->
    <link rel="icon" href="/favicon.ico">
    <!-- <link href="favicon.ico" rel="shortcut icon" type="image/x-icon" /> -->
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?bd7ea96a22c9c7b90353962460fa0b8e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            rel="noopener noreferrer"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Producer"><span class="toc-text">Producer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Result处理"><span class="toc-text">Result处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Producer的兄弟姐妹"><span class="toc-text">Producer的兄弟姐妹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bitmap缓存系列Producer"><span class="toc-text">Bitmap缓存系列Producer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#未解码图片的内存缓存与磁盘缓存系列Producer"><span class="toc-text">未解码图片的内存缓存与磁盘缓存系列Producer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#网络请求Producer"><span class="toc-text">网络请求Producer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-Fresco源码分析之Producer" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Fresco源码分析之Producer</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2017.12.28</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>idisfkj</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/android/">android</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      

      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>Fresco&#x6709;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;&#xFF0C;&#x5206;&#x522B;&#x4E3A;Bitmap&#x7F13;&#x5B58;&#x3001;&#x672A;&#x89E3;&#x7801;&#x56FE;&#x7247;&#x7684;&#x5185;&#x5B58;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x3002;&#x5982;&#x679C;&#x8FD9;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x8BF7;&#x6C42;&#x7684;&#x56FE;&#x7247;&#x65F6;&#xFF0C;&#x624D;&#x4F1A;&#x8D70;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x8FD9;&#x6761;&#x8DEF;&#x3002;&#x90A3;&#x4E48;Fresco&#x53C8;&#x662F;&#x600E;&#x4E48;&#x7BA1;&#x7406;&#x8FD9;&#x4E9B;&#x7F13;&#x5B58;&#xFF0C;&#x6216;&#x8005;&#x8BF4;&#x5982;&#x4F55;&#x4ECE;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x4E2D;&#x83B7;&#x53D6;&#x5230;&#x6700;&#x7EC8;&#x7684;Result&#x5E76;&#x4E14;&#x8FD4;&#x56DE;&#x7ED9;UI&#x5C42;&#x7684;&#x5462;&#xFF1F;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5C31;&#x8BE5;Producer&#x51FA;&#x573A;&#x4E86;&#x3002;</p>
<h2 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h2><p>&#x9996;&#x5148;Producer&#x662F;&#x4E00;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x5B83;&#x5185;&#x90E8;&#x5C31;&#x4E00;&#x4E2A;&#x5F85;&#x5B9E;&#x73B0;&#x7684;&#x65B9;&#x6CD5;produceResults</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public interface Producer&lt;T&gt; {</div><div class="line"> </div><div class="line">  /**</div><div class="line">   * Start producing results for given context. Provided consumer is notified whenever progress is</div><div class="line">   * made (new value is ready or error occurs).</div><div class="line">   * @param consumer</div><div class="line">   * @param context</div><div class="line">   */</div><div class="line">  void produceResults(Consumer&lt;T&gt; consumer, ProducerContext context);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>Producer&#x4E3B;&#x8981;&#x7528;&#x6765;&#x6267;&#x884C;&#x5BF9;&#x56FE;&#x7247;&#x8D44;&#x6E90;&#x83B7;&#x53D6;&#x7684;&#x591A;&#x6837;&#x65B9;&#x5F0F;&#x5904;&#x7406;&#x3002;&#x4F8B;&#x5982;&#xFF1A;&#x7F51;&#x7EDC;&#x65B9;&#x5F0F;&#x3001;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x65B9;&#x5F0F;&#x3001;&#x5185;&#x5B58;&#x7F13;&#x5B58;&#x65B9;&#x5F0F;&#x3001;&#x89E3;&#x7801;&#x65B9;&#x5F0F;&#x4E0E;&#x4E00;&#x4E9B;&#x65CB;&#x8F6C;&#x53D8;&#x6362;&#x7B49;&#x64CD;&#x4F5C;&#x3002;&#x8FD9;&#x91CC;&#x7684;Consumer&#x4E3B;&#x8981;&#x4F5C;&#x4E3A;&#x56DE;&#x8C03;&#xFF0C;&#x7531;&#x4E8E;Producer&#x591A;&#x6837;&#x65B9;&#x5F0F;&#x7684;&#x5904;&#x7406;&#x903B;&#x8F91;&#x662F;&#x901A;&#x8FC7;&#x5185;&#x90E8;&#x9012;&#x5F52;&#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x9012;&#x5F52;&#x56DE;&#x8C03;&#x5904;&#x7406;&#x662F;&#x5FC5;&#x4E0D;&#x53EF;&#x5C11;&#x7684;&#xFF1B;&#x540C;&#x65F6;&#x5BF9;&#x4E8E;&#x5185;&#x90E8;&#x9012;&#x5F52;&#x65F6;&#x4E00;&#x4E9B;&#x6570;&#x636E;&#x7684;&#x4F20;&#x9012;&#xFF0C;&#x5219;&#x662F;&#x901A;&#x8FC7;ProducerContext&#x6765;&#x8FDB;&#x884C;&#x3002;ProducerContext&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x63D0;&#x4F9B;&#x83B7;&#x53D6;&#x9700;&#x8981;&#x4F20;&#x9012;&#x7684;&#x6570;&#x636E;&#x7684;&#x62BD;&#x8C61;&#x65B9;&#x6CD5;&#x3002;</p>
<h2 id="Result&#x5904;&#x7406;"><a href="#Result&#x5904;&#x7406;" class="headerlink" title="Result&#x5904;&#x7406;"></a>Result&#x5904;&#x7406;</h2><p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x4E0B;&#x6700;&#x7EC8;&#x7684;Producer&#x8FD4;&#x56DE;&#x7684;Result&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;&#x3002;&#x770B;&#x4E0B;&#x5B83;&#x662F;&#x5982;&#x679C;&#x5C06;&#x6570;&#x636E;&#x4F20;&#x9012;&#x7ED9;UI&#x5C42;&#xFF0C;&#x4F7F;&#x5F97;UI&#x66F4;&#x65B0;&#x52A0;&#x8F7D;&#x7684;&#x56FE;&#x7247;&#x89C6;&#x56FE;&#x3002;</p>
<p>&#x5728;&#x4E0A;&#x4E00;&#x7BC7;&#x5173;&#x4E8E;Controller&#x7684;&#x6587;&#x7AE0;&#x4E2D;&#xFF0C;&#x63D0;&#x5230;&#x5BF9;&#x4E8E;DataSource&#x662F;&#x901A;&#x8FC7;ImagePipeline&#x4E2D;&#x7684;fetchDecodeImage&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x7684;&#x3002;&#x6211;&#x4EEC;&#x6765;&#x91CD;&#x6E29;&#x5B83;&#x7684;&#x65B9;&#x6CD5;&#x5B9E;&#x73B0;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public DataSource&lt;CloseableReference&lt;CloseableImage&gt;&gt; fetchDecodedImage(</div><div class="line">    ImageRequest imageRequest,</div><div class="line">    Object callerContext,</div><div class="line">    ImageRequest.RequestLevel lowestPermittedRequestLevelOnSubmit) {</div><div class="line">  try {</div><div class="line">    Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; producerSequence =</div><div class="line">        mProducerSequenceFactory.getDecodedImageProducerSequence(imageRequest);</div><div class="line">    return submitFetchRequest(</div><div class="line">        producerSequence,</div><div class="line">        imageRequest,</div><div class="line">        lowestPermittedRequestLevelOnSubmit,</div><div class="line">        callerContext);</div><div class="line">  } catch (Exception exception) {</div><div class="line">    return DataSources.immediateFailedDataSource(exception);</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5982;&#x613F;&#x770B;&#x5230;&#x4E86;Producer&#xFF0C;&#x5B83;&#x7684;&#x5185;&#x90E8;&#x9012;&#x5F52;&#x5148;&#x4E0D;&#x770B;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E0B;&#x4E00;&#x6B65;submitFetchRequest&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">private &lt;T&gt; DataSource&lt;CloseableReference&lt;T&gt;&gt; submitFetchRequest(</div><div class="line">    Producer&lt;CloseableReference&lt;T&gt;&gt; producerSequence,</div><div class="line">    ImageRequest imageRequest,</div><div class="line">    ImageRequest.RequestLevel lowestPermittedRequestLevelOnSubmit,</div><div class="line">    Object callerContext) {</div><div class="line">  final RequestListener requestListener = getRequestListenerForRequest(imageRequest);</div><div class="line"> </div><div class="line">  try {</div><div class="line">    ImageRequest.RequestLevel lowestPermittedRequestLevel =</div><div class="line">        ImageRequest.RequestLevel.getMax(</div><div class="line">            imageRequest.getLowestPermittedRequestLevel(),</div><div class="line">            lowestPermittedRequestLevelOnSubmit);</div><div class="line">    SettableProducerContext settableProducerContext = new SettableProducerContext(</div><div class="line">        imageRequest,</div><div class="line">        generateUniqueFutureId(),</div><div class="line">        requestListener,</div><div class="line">        callerContext,</div><div class="line">        lowestPermittedRequestLevel,</div><div class="line">      /* isPrefetch */ false,</div><div class="line">        imageRequest.getProgressiveRenderingEnabled() ||</div><div class="line">            imageRequest.getMediaVariations() != null ||</div><div class="line">            !UriUtil.isNetworkUri(imageRequest.getSourceUri()),</div><div class="line">        imageRequest.getPriority());</div><div class="line">    return CloseableProducerToDataSourceAdapter.create(</div><div class="line">        producerSequence,</div><div class="line">        settableProducerContext,</div><div class="line">        requestListener);</div><div class="line">  } catch (Exception exception) {</div><div class="line">    return DataSources.immediateFailedDataSource(exception);</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5728;&#x8FD9;&#x91CC;&#x8BA9;&#x6211;&#x4EEC;&#x5B9A;&#x4F4D;&#x5230;SettableProducerContext&#xFF0C;&#x5B83;&#x5B9E;&#x73B0;&#x4E86;ProducerContext&#x63A5;&#x53E3;&#xFF0C;&#x7528;&#x6765;&#x5BF9;producerSequence&#x7684;&#x5185;&#x90E8;&#x9012;&#x5F52;&#x7684;&#x6570;&#x636E;&#x4F20;&#x9012;&#x3002;&#x4F8B;&#x5982;&#xFF1A;ImageRequest&#x3001;Id&#x3001;ProducerListener&#x4E0E;RequestLevel&#x7B49;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x4E0B;&#x4E00;&#x6B65;&#x5C31;&#x662F;&#x771F;&#x6B63;&#x7684;DataSource&#x7684;&#x521B;&#x5EFA;CloseableProducerToDataSourceAdapter.creat()&#x3002;&#x5B83;&#x7EE7;&#x627F;&#x4E8E;AbstractProducerToDataSourceAdapter&#xFF0C;&#x5B83;&#x7684;&#x7236;&#x7C7B;AbstractDataSource&#x5B9E;&#x73B0;&#x4E86;DataSource&#x63A5;&#x53E3;&#x3002;&#x5728;AbstractProducerToDataSourceAdapter&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#x80FD;&#x591F;&#x627E;&#x5230;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x7684;&#x4E1C;&#x897F;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">protected AbstractProducerToDataSourceAdapter(</div><div class="line">    Producer&lt;T&gt; producer,</div><div class="line">    SettableProducerContext settableProducerContext,</div><div class="line">    RequestListener requestListener) {</div><div class="line">  mSettableProducerContext = settableProducerContext;</div><div class="line">  mRequestListener = requestListener;</div><div class="line">  mRequestListener.onRequestStart(</div><div class="line">      settableProducerContext.getImageRequest(),</div><div class="line">      mSettableProducerContext.getCallerContext(),</div><div class="line">      mSettableProducerContext.getId(),</div><div class="line">      mSettableProducerContext.isPrefetch());</div><div class="line">  //PostprocessedBitmapMemoryCacheProducer</div><div class="line">  producer.produceResults(createConsumer(), settableProducerContext);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>settableProducerContext&#x6570;&#x636E;&#x4F20;&#x9012;&#x4F7F;&#x7528;&#x7684;&#x51FA;&#x795E;&#x5165;&#x5316;&#x3002;&#x8C03;&#x7528;&#x4E86;Producer&#x7684;produceResults&#x65B9;&#x6CD5;&#xFF0C;&#x5F00;&#x542F;&#x9012;&#x5F52;&#x8C03;&#x7528;&#x5404;&#x4E2A;Producer&#xFF0C;&#x56E0;&#x4E3A;&#x6BCF;&#x4E00;&#x4E2A;Producer&#x7684;produceResults&#x65B9;&#x6CD5;&#x4E2D;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x83B7;&#x53D6;&#x5230;&#x6700;&#x7EC8;&#x7684;&#x56FE;&#x7247;&#x8D44;&#x6E90;&#xFF0C;&#x90FD;&#x4F1A;&#x8C03;&#x7528;&#x4E0B;&#x4E00;&#x4E2A;Producer&#x7684;produceResults&#x65B9;&#x6CD5;&#xFF0C;&#x6700;&#x7EC8;&#x901A;&#x8FC7;Consumer&#x56DE;&#x8C03;&#x5230;&#x6700;&#x521D;&#x7684;Producer&#x4E2D;&#xFF0C;&#x5373;createConsumer()&#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">private Consumer&lt;T&gt; createConsumer() {</div><div class="line">  return new BaseConsumer&lt;T&gt;() {</div><div class="line">    @Override</div><div class="line">    protected void onNewResultImpl(@Nullable T newResult, @Status int status) {</div><div class="line">      AbstractProducerToDataSourceAdapter.this.onNewResultImpl(newResult, status);</div><div class="line">    }</div><div class="line"> </div><div class="line">    @Override</div><div class="line">    protected void onFailureImpl(Throwable throwable) {</div><div class="line">      AbstractProducerToDataSourceAdapter.this.onFailureImpl(throwable);</div><div class="line">    }</div><div class="line"> </div><div class="line">    @Override</div><div class="line">    protected void onCancellationImpl() {</div><div class="line">      AbstractProducerToDataSourceAdapter.this.onCancellationImpl();</div><div class="line">    }</div><div class="line"> </div><div class="line">    @Override</div><div class="line">    protected void onProgressUpdateImpl(float progress) {</div><div class="line">      AbstractProducerToDataSourceAdapter.this.setProgress(progress);</div><div class="line">    }</div><div class="line">  };</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5728;createConsumer()&#x4E2D;&#x5206;&#x522B;&#x8C03;&#x7528;&#x4E86;onNewResultImpl&#x3001;onFailureImpl&#x3001;setProgress&#x4E0E;onCancellationImpl&#x65B9;&#x6CD5;&#x3002;&#x5206;&#x522B;&#x4EE3;&#x8868;&#x6210;&#x529F;&#x7684;&#x56DE;&#x8C03;&#x3001;&#x5931;&#x8D25;&#x7684;&#x56DE;&#x8C03;&#x3001;&#x8BF7;&#x6C42;&#x8FDB;&#x5EA6;&#x56DE;&#x8C03;&#x4E0E;&#x8BF7;&#x6C42;&#x53D6;&#x6D88;&#x56DE;&#x8C03;&#x3002;&#x5BF9;&#x4E8E;&#x524D;&#x4E09;&#x56DE;&#x8C03;&#x90FD;&#x4F1A;&#x89E6;&#x53D1;AbstractDataSource&#x4E2D;&#x7684;notifyDataSubscribers()&#x65B9;&#x6CD5;&#x3002;&#x4F8B;&#x5982;onNewResultImpl&#x65B9;&#x6CD5;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">protected void onNewResultImpl(@Nullable T result, int status) {</div><div class="line">  boolean isLast = BaseConsumer.isLast(status);</div><div class="line">  //setResult&#x5C06;&#x7ED3;&#x679C;&#x4F20;&#x5165;AbstractDataSource&#x4E2D;</div><div class="line">  if (super.setResult(result, isLast)) {</div><div class="line">    if (isLast) {</div><div class="line">      mRequestListener.onRequestSuccess(</div><div class="line">          mSettableProducerContext.getImageRequest(),</div><div class="line">          mSettableProducerContext.getId(),</div><div class="line">          mSettableProducerContext.isPrefetch());</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x8C03;&#x7528;&#x4E86;&#x7236;&#x7C7B;&#x7684;super.setResult()&#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">protected boolean setResult(@Nullable T value, boolean isLast) {</div><div class="line">  //&#x5C06;&#x4ECE;Producer&#x4E2D;&#x83B7;&#x53D6;&#x90FD;&#x7684;&#x6570;&#x636E;&#x6E90;&#x4FDD;&#x5B58;&#x5230;mResult&#x4E2D;,&#x5916;&#x90E8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;getResult&#x83B7;&#x53D6;&#x3002;</div><div class="line">  boolean result = setResultInternal(value, isLast);</div><div class="line">  if (result) {</div><div class="line">    notifyDataSubscribers();</div><div class="line">  }</div><div class="line">  return result;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>Result&#x4FDD;&#x5B58;&#x5230;DataSource&#x4E2D;&#x7684;mResult&#x4E2D;&#xFF0C;&#x5728;&#x4E4B;&#x524D;&#x7684;Controller&#x4E2D;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8C03;&#x7528;DataSource&#x7684;getResult&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x8BF7;&#x6C42;&#x7684;Result&#x3002;Controller&#x5BF9;DataSource&#x7684;&#x8BA2;&#x9605;&#x4E5F;&#x5C06;&#x901A;&#x8FC7;notifyDataSubscribers()&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x901A;&#x77E5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">private void notifyDataSubscribers() {</div><div class="line">  final boolean isFailure = hasFailed();</div><div class="line">  final boolean isCancellation = wasCancelled();</div><div class="line">  //&#x901A;&#x77E5;&#x6240;&#x6709;&#x7684;&#x8BA2;&#x9605;&#x8005;</div><div class="line">  for (Pair&lt;DataSubscriber&lt;T&gt;, Executor&gt; pair : mSubscribers) {</div><div class="line">    notifyDataSubscriber(pair.first, pair.second, isFailure, isCancellation);</div><div class="line">  }</div><div class="line">}</div><div class="line"> </div><div class="line">private void notifyDataSubscriber(</div><div class="line">    final DataSubscriber&lt;T&gt; dataSubscriber,</div><div class="line">    final Executor executor,</div><div class="line">    final boolean isFailure,</div><div class="line">    final boolean isCancellation) {</div><div class="line">  executor.execute(</div><div class="line">      new Runnable() {</div><div class="line">        @Override</div><div class="line">        public void run() {</div><div class="line">          if (isFailure) {</div><div class="line">            dataSubscriber.onFailure(AbstractDataSource.this);</div><div class="line">          } else if (isCancellation) {</div><div class="line">            dataSubscriber.onCancellation(AbstractDataSource.this);</div><div class="line">          } else {</div><div class="line">            dataSubscriber.onNewResult(AbstractDataSource.this);</div><div class="line">          }</div><div class="line">        }</div><div class="line">      });</div><div class="line">}</div></pre></td></tr></table></figure>
<p>executor.execute()&#x65B9;&#x6CD5;&#x89E3;&#x91CA;&#x4E86;&#x4E00;&#x5207;&#x3002;&#x8C03;&#x7528;&#x4E86;Controller&#x4E2D;&#x4F20;&#x9012;&#x8FC7;&#x6765;&#x7684;dataSubscriber&#x7684;&#x5404;&#x4E2A;&#x56DE;&#x8C03;&#x3002;&#x90A3;&#x4E48;Result&#x7684;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x5C31;&#x8D70;&#x901A;&#x4E86;&#x3002;</p>
<blockquote>
<p>&#x5982;&#x9700;&#x4E86;&#x89E3;Controller&#xFF0C;&#x63A8;&#x8350;&#x9605;&#x8BFB;<a href="https://idisfkj.github.io/2017/12/14/Fresco%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BController/" target="_blank" rel="external">Fresco&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E4B;Controller
</a></p>
</blockquote>
<h2 id="Producer&#x7684;&#x5144;&#x5F1F;&#x59D0;&#x59B9;"><a href="#Producer&#x7684;&#x5144;&#x5F1F;&#x59D0;&#x59B9;" class="headerlink" title="Producer&#x7684;&#x5144;&#x5F1F;&#x59D0;&#x59B9;"></a>Producer&#x7684;&#x5144;&#x5F1F;&#x59D0;&#x59B9;</h2><p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x6765;&#x8BA4;&#x8BC6;&#x4E0B;Producer&#x7684;&#x5BB6;&#x5EAD;&#x6210;&#x5458;&#x3002;&#x56DE;&#x5230;&#x6700;&#x521D;&#x7684;fetchDecodedImage()&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x5230;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; producerSequence =</div><div class="line">    mProducerSequenceFactory.getDecodedImageProducerSequence(imageRequest);</div></pre></td></tr></table></figure>
<p>Producer&#x7684;&#x5BB6;&#x5EAD;&#x6210;&#x5458;&#x7684;&#x51FA;&#x751F;&#x5730;&#x90FD;&#x662F;ProducerSequenceFactory&#x5DE5;&#x5382;&#x3002;&#x6700;&#x5148;&#x51FA;&#x751F;&#x7684;&#x662F;&#x89E3;&#x7801;&#x4E86;&#x7684;ImageProducer&#x6210;&#x5458;&#x3002;&#x901A;&#x8FC7;getDecodeImageProducerSquence()&#x65B9;&#x6CD5;&#x83B7;&#x53D6;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; getDecodedImageProducerSequence(</div><div class="line">    ImageRequest imageRequest) {</div><div class="line">  //&#x901A;&#x8FC7;Uri&#x7C7B;&#x578B;&#x6765;&#x83B7;&#x53D6;&#x4E0D;&#x540C;&#x7684;&#x8BF7;&#x6C42;&#x961F;&#x5217;</div><div class="line">  Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; pipelineSequence =</div><div class="line">      getBasicDecodedImageSequence(imageRequest);</div><div class="line"> </div><div class="line">  // &#x901A;&#x8FC7;ImageRequestBuilder.setPostprocessor()&#x8BBE;&#x7F6E;, &#x4E00;&#x822C;&#x4E3A;null&#x3002;</div><div class="line">  // &#x4F5C;&#x7528;&#x662F;&#x7528;&#x6765;&#x5BF9;&#x83B7;&#x53D6;&#x5230;&#x7684;Bitmap&#x8FDB;&#x884C;&#x52A0;&#x5DE5;&#x5904;&#x7406;&#x3002;&#x4F8B;&#x5982;&#xFF1A;&#x6DFB;&#x52A0;&#x6C34;&#x5370;&#x7B49;&#x3002;</div><div class="line">  if (imageRequest.getPostprocessor() != null) {</div><div class="line">    pipelineSequence = getPostprocessorSequence(pipelineSequence);</div><div class="line">  }</div><div class="line"> </div><div class="line">  //&#x4E00;&#x822C;&#x7528;&#x6765;&#x5B9E;&#x9A8C;&#xFF0C;ImagePipelineConfig.Builder-&gt;ImagePipelineExperiments-&gt;setBitmapPrepareToDraw</div><div class="line">  //&#x6240;&#x4EE5;&#x6B63;&#x5E38;&#x60C5;&#x51B5;&#x90FD;&#x4E3A;false</div><div class="line">  if (mUseBitmapPrepareToDraw) {</div><div class="line">    pipelineSequence = getBitmapPrepareSequence(pipelineSequence);</div><div class="line">  }</div><div class="line">  return pipelineSequence;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x7684;&#x6CE8;&#x91CA;&#x5DF2;&#x7ECF;&#x5F88;&#x6E05;&#x695A;&#x4E86;&#xFF0C;&#x6B63;&#x5E38;&#x7684;&#x6D41;&#x7A0B;&#x53EA;&#x9700;&#x5173;&#x6CE8;getBasicDecodedImageSequence()&#x65B9;&#x6CD5;&#x3002;&#x5176;&#x5B83;&#x7684;&#x90FD;&#x662F;&#x5BF9;&#x83B7;&#x53D6;&#x5230;&#x7684;Result&#x8FDB;&#x884C;&#x52A0;&#x5DE5;&#x5904;&#x7406;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x771F;&#x6B63;&#x7684;Result&#x83B7;&#x53D6;&#x6B65;&#x9AA4;&#x3002;&#x90A3;&#x4E48;&#x7EE7;&#x7EED;&#x770B;getBasicDecodedImageSequence&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">private Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; getBasicDecodedImageSequence(</div><div class="line">    ImageRequest imageRequest) {</div><div class="line">  Preconditions.checkNotNull(imageRequest);</div><div class="line"> </div><div class="line">  Uri uri = imageRequest.getSourceUri();</div><div class="line">  Preconditions.checkNotNull(uri, &quot;Uri is null.&quot;);</div><div class="line"> </div><div class="line">  switch (imageRequest.getSourceUriType()) {</div><div class="line">    case SOURCE_TYPE_NETWORK:</div><div class="line">      return getNetworkFetchSequence();</div><div class="line">    case SOURCE_TYPE_LOCAL_VIDEO_FILE:</div><div class="line">      return getLocalVideoFileFetchSequence();</div><div class="line">    case SOURCE_TYPE_LOCAL_IMAGE_FILE:</div><div class="line">      return getLocalImageFileFetchSequence();</div><div class="line">    case SOURCE_TYPE_LOCAL_CONTENT:</div><div class="line">      if (MediaUtils.isVideo(mContentResolver.getType(uri))) {</div><div class="line">        return getLocalVideoFileFetchSequence();</div><div class="line">      }</div><div class="line">      return getLocalContentUriFetchSequence();</div><div class="line">    case SOURCE_TYPE_LOCAL_ASSET:</div><div class="line">      return getLocalAssetFetchSequence();</div><div class="line">    case SOURCE_TYPE_LOCAL_RESOURCE:</div><div class="line">      return getLocalResourceFetchSequence();</div><div class="line">    case SOURCE_TYPE_QUALIFIED_RESOURCE:</div><div class="line">      return getQualifiedResourceFetchSequence();</div><div class="line">    case SOURCE_TYPE_DATA:</div><div class="line">      return getDataFetchSequence();</div><div class="line">    default:</div><div class="line">      throw new IllegalArgumentException(</div><div class="line">          &quot;Unsupported uri scheme! Uri is: &quot; + getShortenedUriString(uri));</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5230;&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x5206;&#x6C34;&#x5CAD;&#xFF0C;&#x6839;&#x636E;ImageRequest&#x7684;SourceUriType&#xFF0C;&#x6765;&#x51B3;&#x5B9A;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x8D44;&#x6E90;&#x7684;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#x3002;&#x8FD9;&#x91CC;&#x4EE5;SOURCE_TYPE_NETWORK&#x8FDB;&#x884C;&#x8BE6;&#x7EC6;&#x5206;&#x6790;&#xFF0C;getNetworkFetchSequence&#x662F;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x7684;&#x83B7;&#x53D6;&#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">private synchronized Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; getNetworkFetchSequence() {</div><div class="line">  if (mNetworkFetchSequence == null) {</div><div class="line">    mNetworkFetchSequence =</div><div class="line">        newBitmapCacheGetToDecodeSequence(getCommonNetworkFetchToEncodedMemorySequence());</div><div class="line">  }</div><div class="line">  return mNetworkFetchSequence;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x6587;&#x7AE0;&#x5F00;&#x5934;&#x5DF2;&#x7ECF;&#x63D0;&#x53CA;&#x5230;Fresco&#x6709;&#x4E09;&#x7EA7;&#x7F13;&#x5B58;&#xFF1A;Bitmap&#x7F13;&#x5B58;&#x3001;&#x672A;&#x89E3;&#x7801;&#x56FE;&#x7247;&#x7684;&#x5185;&#x5B58;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x3002;&#x6839;&#x636E;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x9996;&#x5148;&#x7684;&#x4ECE;Bitmap&#x7F13;&#x5B58;&#x5230;&#x56FE;&#x7247;&#x89E3;&#x7801;&#xFF0C;Bitmap&#x7F13;&#x5B58;&#x5728;newBitmapCacheGetToDecodeSequence&#x4E2D;&#x3002;&#x81F3;&#x4E8E;&#x56FE;&#x7247;&#x89E3;&#x7801;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;DecodeProducer&#x8FDB;&#x884C;&#x5B9E;&#x73B0;&#x3002;</p>
<h3 id="Bitmap&#x7F13;&#x5B58;&#x7CFB;&#x5217;Producer"><a href="#Bitmap&#x7F13;&#x5B58;&#x7CFB;&#x5217;Producer" class="headerlink" title="Bitmap&#x7F13;&#x5B58;&#x7CFB;&#x5217;Producer"></a>Bitmap&#x7F13;&#x5B58;&#x7CFB;&#x5217;Producer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">private Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; newBitmapCacheGetToDecodeSequence(</div><div class="line">    Producer&lt;EncodedImage&gt; inputProducer) {</div><div class="line">  //&#x89E3;&#x7801;Producer,&#x5BF9;&#x4E8E;&#x56FE;&#x7247;&#x7684;&#x89E3;&#x7801;&#x64CD;&#x4F5C;&#x90FD;&#x5728;DecodeProducer&#x4E2D;&#x8FDB;&#x884C;</div><div class="line">  DecodeProducer decodeProducer = mProducerFactory.newDecodeProducer(inputProducer);</div><div class="line">  //&#x83B7;&#x53D6;Bitmap&#x7F13;&#x5B58;&#x8D44;&#x6E90;</div><div class="line">  return newBitmapCacheGetToBitmapCacheSequence(decodeProducer);</div><div class="line">}</div><div class="line"></div><div class="line">  private Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; newBitmapCacheGetToBitmapCacheSequence(</div><div class="line">    Producer&lt;CloseableReference&lt;CloseableImage&gt;&gt; inputProducer) {</div><div class="line">  BitmapMemoryCacheProducer bitmapMemoryCacheProducer =</div><div class="line">      mProducerFactory.newBitmapMemoryCacheProducer(inputProducer);</div><div class="line">  BitmapMemoryCacheKeyMultiplexProducer bitmapKeyMultiplexProducer =</div><div class="line">      mProducerFactory.newBitmapMemoryCacheKeyMultiplexProducer(bitmapMemoryCacheProducer);</div><div class="line">  ThreadHandoffProducer&lt;CloseableReference&lt;CloseableImage&gt;&gt; threadHandoffProducer =</div><div class="line">      mProducerFactory.newBackgroundThreadHandoffProducer(</div><div class="line">          bitmapKeyMultiplexProducer,</div><div class="line">          mThreadHandoffProducerQueue);</div><div class="line">  return mProducerFactory.newBitmapMemoryCacheGetProducer(threadHandoffProducer);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5728;&#x83B7;&#x53D6;Bitmap&#x7F13;&#x5B58;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F9D;&#x6B21;&#x4F7F;&#x7528;&#x4E86;BitmapMemoryCacheGetProducer&#x3001;ThreadHandoffProducer&#x3001;BitmapMemoryCacheKeyMultiplexProducer&#x4E0E;BitmapMemoryCacheProducer&#x3002;</p>
<blockquote>
<p>&#x5982;&#x679C;&#x60F3;&#x4E86;&#x89E3;&#x5982;&#x679C;&#x83B7;&#x53D6;Bitmap&#x7F13;&#x5B58;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x67E5;&#x770B;BitmapMemoryCacheProducer&#x3002;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x53D7;&#x9650;&#xFF0C;&#x8FD9;&#x91CC;&#x4E0D;&#x5BF9;&#x5404;&#x4E2A;Producer&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x7EC6;&#x8282;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#xFF0C;&#x540E;&#x7EED;&#x4F1A;&#x5355;&#x72EC;&#x5F00;&#x7BC7;&#x5E45;&#x8FDB;&#x884C;&#x5206;&#x6790;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x3002;</p>
</blockquote>
<h3 id="&#x672A;&#x89E3;&#x7801;&#x56FE;&#x7247;&#x7684;&#x5185;&#x5B58;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x7CFB;&#x5217;Producer"><a href="#&#x672A;&#x89E3;&#x7801;&#x56FE;&#x7247;&#x7684;&#x5185;&#x5B58;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x7CFB;&#x5217;Producer" class="headerlink" title="&#x672A;&#x89E3;&#x7801;&#x56FE;&#x7247;&#x7684;&#x5185;&#x5B58;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x7CFB;&#x5217;Producer"></a>&#x672A;&#x89E3;&#x7801;&#x56FE;&#x7247;&#x7684;&#x5185;&#x5B58;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x7CFB;&#x5217;Producer</h3><p>&#x56DE;&#x5230;&#x4E4B;&#x524D;&#x7684;getNetworkFetchSequence&#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;Bitmap&#x7F13;&#x5B58;&#x6CA1;&#x6709;&#x83B7;&#x53D6;&#x5230;&#x6700;&#x7EC8;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x90A3;&#x4E48;&#x4F1A;&#x8FDB;&#x5165;getCommonNetworkFetchToEncodedMemorySequence&#xFF0C;&#x8FDB;&#x4E00;&#x6B65;&#x901A;&#x8FC7;&#x672A;&#x89E3;&#x7801;&#x7684;&#x56FE;&#x7247;&#x5185;&#x5B58;&#x7F13;&#x5B58;&#x4E0E;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x83B7;&#x53D6;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">private synchronized Producer&lt;EncodedImage&gt; getCommonNetworkFetchToEncodedMemorySequence() {</div><div class="line">  if (mCommonNetworkFetchToEncodedMemorySequence == null) {</div><div class="line">    //&#x672A;&#x89E3;&#x7801;&#x7684;&#x56FE;&#x7247;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;-&gt;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;</div><div class="line">    Producer&lt;EncodedImage&gt; inputProducer =</div><div class="line">        newEncodedCacheMultiplexToTranscodeSequence(</div><div class="line">            mProducerFactory.newNetworkFetchProducer(mNetworkFetcher));</div><div class="line">    //&#x5BF9;&#x56FE;&#x7247;&#x7684;Meta Data&#x8FDB;&#x884C;&#x8F6C;&#x6362;</div><div class="line">    mCommonNetworkFetchToEncodedMemorySequence =</div><div class="line">        ProducerFactory.newAddImageTransformMetaDataProducer(inputProducer);</div><div class="line">    //&#x5BF9;JPEG&#x683C;&#x5F0F;&#x7684;&#x56FE;&#x7247;&#x8FDB;&#x884C;&#x7F29;&#x653E;&#x4E0E;&#x65CB;&#x8F6C;&#x64CD;&#x4F5C;</div><div class="line">    mCommonNetworkFetchToEncodedMemorySequence =</div><div class="line">        mProducerFactory.newResizeAndRotateProducer(</div><div class="line">            mCommonNetworkFetchToEncodedMemorySequence,</div><div class="line">            mResizeAndRotateEnabledForNetwork,</div><div class="line">            mUseDownsamplingRatio);</div><div class="line">  }</div><div class="line">  return mCommonNetworkFetchToEncodedMemorySequence;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5728;&#x8FD9;&#x91CC;&#x9996;&#x5148;&#x4F1A;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x8F6C;&#x6362;&#x64CD;&#x4F5C;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;ResizeAndRotateProducer&#x4F5C;&#x7528;&#x662F;&#x5BF9;JPEG&#x683C;&#x5F0F;&#x7684;&#x56FE;&#x7247;&#x6839;&#x636E;EXIF&#x7684;orientation&#x4E0E;&#x6307;&#x5B9A;&#x7684;rotation&#x8FDB;&#x884C;&#x7F29;&#x653E;&#x4E0E;&#x65CB;&#x8F6C;&#x64CD;&#x4F5C;&#x3002;&#x4E4B;&#x540E;&#x5C31;&#x662F;AddImageTransformMetaDataProducer&#x5BF9;&#x56FE;&#x7247;&#x7684;Meta Data&#x8FDB;&#x884C;&#x8F6C;&#x6362;&#x3002;&#x6700;&#x540E;&#x8C03;&#x7528;newEncodedCacheMultiplexToTranscodeSequence&#x8FDB;&#x884C;&#x672A;&#x89E3;&#x7801;&#x7684;&#x56FE;&#x7247;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x64CD;&#x4F5C;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">private Producer&lt;EncodedImage&gt; newEncodedCacheMultiplexToTranscodeSequence(</div><div class="line">    Producer&lt;EncodedImage&gt; inputProducer) {</div><div class="line">  //&#x5BF9;webp&#x56FE;&#x7247;&#x8FDB;&#x884C;&#x8F6C;&#x7801;</div><div class="line">  if (WebpSupportStatus.sIsWebpSupportRequired &amp;&amp;</div><div class="line">      (!mWebpSupportEnabled || WebpSupportStatus.sWebpBitmapFactory == null)) {</div><div class="line">    inputProducer = mProducerFactory.newWebpTranscodeProducer(inputProducer);</div><div class="line">  }</div><div class="line">  //&#x78C1;&#x76D8;&#x7F13;&#x5B58;</div><div class="line">  inputProducer = newDiskCacheSequence(inputProducer);</div><div class="line">  //&#x672A;&#x89E3;&#x7801;&#x7684;&#x56FE;&#x7247;&#x7F13;&#x5B58;</div><div class="line">  EncodedMemoryCacheProducer encodedMemoryCacheProducer =</div><div class="line">      mProducerFactory.newEncodedMemoryCacheProducer(inputProducer);</div><div class="line">  //&#x8FDB;&#x884C;&#x591A;&#x8DEF;&#x590D;&#x7528;&#x64CD;&#x4F5C;&#xFF0C;&#x901A;&#x8FC7;&#x672A;&#x89E3;&#x7801;&#x7684;&#x7F13;&#x5B58;&#x4F5C;&#x4E3A;key,&#x6765;&#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;request</div><div class="line">  return mProducerFactory.newEncodedCacheKeyMultiplexProducer(encodedMemoryCacheProducer);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x6240;&#x4EE5;&#x5B83;&#x7684;&#x8C03;&#x7528;&#x94FE;&#x662F;&#xFF1A;EncodedCacheKeyMultiplexProducer -&gt; EncodedMemoryCacheProducer -&gt; newDiskCacheSequence -&gt; WebpTranscodeProducer&#x3002;</p>
<p>&#x5982;&#x679C;&#x4EE5;&#x4E0A;&#x6B65;&#x9AA4;&#x90FD;&#x6CA1;&#x6709;&#x83B7;&#x53D6;&#x5230;&#x6700;&#x7EC8;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x6B63;&#x5F0F;&#x8FDB;&#x5165;&#x7F51;&#x7EDC;&#x83B7;&#x53D6;&#x3002;&#x5165;&#x53E3;&#x5728;mProducerFactory.newNetworkFetchProducer(mNetworkFetcher))&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5BF9;&#x5E94;&#x7684;Producer&#x4E3A;NetworkFetchProducer&#x3002;</p>
<h3 id="&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;Producer"><a href="#&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;Producer" class="headerlink" title="&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;Producer"></a>&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;Producer</h3><p>&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x662F;&#x6700;&#x7EC8;&#x7684;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#xFF0C;&#x4E0B;&#x9762;&#x5BF9;NetworkFetchProducer&#x8FDB;&#x884C;&#x7B80;&#x8981;&#x5206;&#x6790;&#xFF0C;&#x76F4;&#x63A5;&#x770B;&#x5B83;&#x7684;&#x6700;&#x7EC8;&#x65B9;&#x6CD5;produceResults&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void produceResults(Consumer&lt;EncodedImage&gt; consumer, ProducerContext context) {</div><div class="line">  context.getListener()</div><div class="line">      .onProducerStart(context.getId(), PRODUCER_NAME);</div><div class="line">  //&#x4FDD;&#x5B58;fetch&#x7684;&#x8BF7;&#x6C42;&#x72B6;&#x6001;&#x4FE1;&#x606F;(Consumer,ProducerContext)</div><div class="line">  final FetchState fetchState = mNetworkFetcher.createFetchState(consumer, context);</div><div class="line">  mNetworkFetcher.fetch(</div><div class="line">      fetchState, new NetworkFetcher.Callback() {</div><div class="line">        @Override</div><div class="line">        public void onResponse(InputStream response, int responseLength) throws IOException {</div><div class="line">          //&#x8BE5;response&#x5373;&#x4E3A;&#x6700;&#x7EC8;&#x8BF7;&#x6C42;&#x56FE;&#x7247;&#x7684;uri&#x54CD;&#x5E94;&#x8D44;&#x6E90;</div><div class="line">          NetworkFetchProducer.this.onResponse(fetchState, response, responseLength);</div><div class="line">        }</div><div class="line"> </div><div class="line">        @Override</div><div class="line">        public void onFailure(Throwable throwable) {</div><div class="line">          NetworkFetchProducer.this.onFailure(fetchState, throwable);</div><div class="line">        }</div><div class="line"> </div><div class="line">        @Override</div><div class="line">        public void onCancellation() {</div><div class="line">          NetworkFetchProducer.this.onCancellation(fetchState);</div><div class="line">        }</div><div class="line">      });</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x9996;&#x5148;&#x901A;&#x8FC7;mNetworkFetcher&#x521B;&#x5EFA;&#x4E86;FetchState&#xFF0C;mNetworkFetcher&#x662F;&#x7F51;&#x7EDC;&#x5C42;&#x8BF7;&#x6C42;&#x65B9;&#x5F0F;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7279;&#x522B;&#x6307;&#x5B9A;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;HttpUrlConnection&#xFF0C;&#x5BF9;&#x5E94;&#x4E3A;HttpUrlConnectionNetworkFetcher&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x8C03;&#x4E86;fetch&#x65B9;&#x6CD5;&#xFF0C;&#x6B63;&#x5F0F;&#x53D1;&#x8D77;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#xFF0C;&#x7EC6;&#x8282;&#x5B9E;&#x73B0;&#x5728;mNetworkFetcher&#x4E2D;&#x3002;&#x5BF9;&#x5E94;&#x7684;&#x56DE;&#x8C03;&#x54CD;&#x5E94;&#x4E3A;onResponse&#x3001;onFailure&#x4E0E;onCancellation&#xFF0C;&#x8FD9;&#x91CC;&#x62FF;onResponse&#x6B65;&#x9AA4;&#x8FDB;&#x884C;&#x5206;&#x6790;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">private void onResponse(</div><div class="line">    FetchState fetchState,</div><div class="line">    InputStream responseData,</div><div class="line">    int responseContentLength)</div><div class="line">    throws IOException {</div><div class="line">  final PooledByteBufferOutputStream pooledOutputStream;</div><div class="line">  //&#x83B7;&#x53D6;pooledOutputStream</div><div class="line">  if (responseContentLength &gt; 0) {</div><div class="line">    pooledOutputStream = mPooledByteBufferFactory.newOutputStream(responseContentLength);</div><div class="line">  } else {</div><div class="line">    pooledOutputStream = mPooledByteBufferFactory.newOutputStream();</div><div class="line">  }</div><div class="line">  final byte[] ioArray = mByteArrayPool.get(READ_SIZE);</div><div class="line">  try {</div><div class="line">    int length;</div><div class="line">    while ((length = responseData.read(ioArray)) &gt;= 0) {</div><div class="line">      if (length &gt; 0) {</div><div class="line">        //&#x5C06;&#x6570;&#x636E;&#x5199;&#x5165;pooledOutputStream&#x4E2D;</div><div class="line">        pooledOutputStream.write(ioArray, 0, length);</div><div class="line">        //&#x5B9A;&#x65F6;&#x89E6;&#x53D1;consumer&#x56DE;&#x8C03;</div><div class="line">        maybeHandleIntermediateResult(pooledOutputStream, fetchState);</div><div class="line">        float progress = calculateProgress(pooledOutputStream.size(), responseContentLength);</div><div class="line">        //&#x8FDB;&#x5EA6;&#x66F4;&#x65B0;</div><div class="line">        fetchState.getConsumer().onProgressUpdate(progress);</div><div class="line">      }</div><div class="line">    }</div><div class="line">    mNetworkFetcher.onFetchCompletion(fetchState, pooledOutputStream.size());</div><div class="line">    //&#x5168;&#x90E8;&#x6570;&#x636E;&#x83B7;&#x53D6;&#x5B8C;&#x6BD5;&#xFF0C;&#x56DE;&#x8C03;Consumer</div><div class="line">    handleFinalResult(pooledOutputStream, fetchState);</div><div class="line">  } finally {</div><div class="line">    mByteArrayPool.release(ioArray);</div><div class="line">    pooledOutputStream.close();</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x6CE8;&#x91CA;&#x89E3;&#x6790;&#xFF0C;&#x4E3B;&#x8981;&#x7684;&#x65B9;&#x6CD5;&#x5C31;&#x4E24;&#x4E2A;&#xFF1A;maybeHandleIntermediateResult&#x4E0E;handleFinalResult&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x662F;&#x5BF9;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x7684;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x53D1;&#x9001;&#x4F20;&#x9012;&#xFF0C;&#x4ED6;&#x4EEC;&#x7684;&#x5185;&#x90E8;&#x5B9E;&#x73B0;&#x90FD;&#x662F;&#x8C03;&#x7528;notifyConsumer&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x56DE;&#x8C03;&#x901A;&#x77E5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">private void maybeHandleIntermediateResult(</div><div class="line">    PooledByteBufferOutputStream pooledOutputStream,</div><div class="line">    FetchState fetchState) {</div><div class="line">  final long nowMs = SystemClock.uptimeMillis();</div><div class="line">  //&#x65F6;&#x95F4;&#x95F4;&#x9694;&#x5927;&#x4E8E;&#x7B49;&#x4E8E;100&#x6BEB;&#x79D2;&#x8FDB;&#x884C;&#x901A;&#x77E5;</div><div class="line">  if (shouldPropagateIntermediateResults(fetchState) &amp;&amp;</div><div class="line">      nowMs - fetchState.getLastIntermediateResultTimeMs() &gt;= TIME_BETWEEN_PARTIAL_RESULTS_MS) {</div><div class="line">    fetchState.setLastIntermediateResultTimeMs(nowMs);</div><div class="line">    fetchState.getListener()</div><div class="line">        .onProducerEvent(fetchState.getId(), PRODUCER_NAME, INTERMEDIATE_RESULT_PRODUCER_EVENT);</div><div class="line">    notifyConsumer(</div><div class="line">        pooledOutputStream,</div><div class="line">        fetchState.getOnNewResultStatusFlags(),</div><div class="line">        fetchState.getResponseBytesRange(),</div><div class="line">        fetchState.getConsumer());</div><div class="line">  }</div><div class="line">}</div><div class="line"> </div><div class="line">private void handleFinalResult(</div><div class="line">    PooledByteBufferOutputStream pooledOutputStream,</div><div class="line">    FetchState fetchState) {</div><div class="line">  Map&lt;String, String&gt; extraMap = getExtraMap(fetchState, pooledOutputStream.size());</div><div class="line">  ProducerListener listener = fetchState.getListener();</div><div class="line">  listener.onProducerFinishWithSuccess(fetchState.getId(), PRODUCER_NAME, extraMap);</div><div class="line">  listener.onUltimateProducerReached(fetchState.getId(), PRODUCER_NAME, true);</div><div class="line">  notifyConsumer(</div><div class="line">      pooledOutputStream,</div><div class="line">      Consumer.IS_LAST | fetchState.getOnNewResultStatusFlags(),</div><div class="line">      fetchState.getResponseBytesRange(),</div><div class="line">      fetchState.getConsumer());</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x5B83;&#x4EEC;&#x6700;&#x4E3B;&#x8981;&#x7684;&#x533A;&#x522B;&#x662F;maybeHandleIntermediateResult&#x662F;&#x95F4;&#x9694;&#x6027;&#x7684;&#x8C03;&#x7528;notifyConsumer&#x901A;&#x77E5;&#x56DE;&#x8C03;&#x8005;&#x3002;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x6700;&#x7EC8;&#x7684;&#x56DE;&#x8C03;&#x901A;&#x77E5;&#x65B9;&#x6CD5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">private void notifyConsumer(</div><div class="line">    PooledByteBufferOutputStream pooledOutputStream,</div><div class="line">    @Consumer.Status int status,</div><div class="line">    @Nullable BytesRange responseBytesRange,</div><div class="line">    Consumer&lt;EncodedImage&gt; consumer) {</div><div class="line">  //&#x5BF9;&#x4E8E;PooledByteBuffer&#x6784;&#x5EFA;&#x53EF;&#x5173;&#x95ED;&#x5F15;&#x7528;CloseableReference</div><div class="line">  CloseableReference&lt;PooledByteBuffer&gt; result =</div><div class="line">      CloseableReference.of(pooledOutputStream.toByteBuffer());</div><div class="line">  EncodedImage encodedImage = null;</div><div class="line">  try {</div><div class="line">    //&#x4FDD;&#x5B58;&#x5230;EncodedImage&#x4E2D;</div><div class="line">    encodedImage = new EncodedImage(result);</div><div class="line">    encodedImage.setBytesRange(responseBytesRange);</div><div class="line">    //&#x89E3;&#x6790;MetaData</div><div class="line">    encodedImage.parseMetaData();</div><div class="line">    //&#x56DE;&#x8C03;&#x901A;&#x77E5;</div><div class="line">    consumer.onNewResult(encodedImage, status);</div><div class="line">  } finally {</div><div class="line">    EncodedImage.closeSafely(encodedImage);</div><div class="line">    CloseableReference.closeSafely(result);</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x9996;&#x5148;&#x5BF9;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x5C01;&#x88C5;&#xFF0C;&#x4FDD;&#x5B58;&#x5230;EncodedImage&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;Consumer&#x56DE;&#x8C03;onNewResult&#x65B9;&#x6CD5;&#x5C06;encodedImage&#x4F20;&#x9012;&#x5230;&#x4E0A;&#x4E00;&#x5C42;&#x7684;Producer&#x7CFB;&#x5217;&#xFF0C;&#x5373;&#x4E4B;&#x524D;&#x6240;&#x8FDB;&#x8FC7;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x672A;&#x89E3;&#x7801;&#x7684;&#x56FE;&#x7247;&#x7F13;&#x5B58;&#x4E0E;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x64CD;&#x4F5C;&#x3002;&#x7B80;&#x5355;&#x7684;&#x8BF4;&#x5C31;&#x662F;&#x901A;&#x8FC7;Consumer&#x5BF9;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x89E3;&#x7801;&#x3001;&#x8F6C;&#x6362;&#x3001;&#x7F13;&#x5B58;&#x7B49;&#x64CD;&#x4F5C;&#xFF0C;&#x6700;&#x7EC8;&#x83B7;&#x53D6;&#x5230;Bitmap&#xFF0C;&#x4F20;&#x9012;&#x7ED9;UI&#x5C42;&#x8FDB;&#x884C;&#x56FE;&#x7247;&#x66F4;&#x65B0;&#x8BBE;&#x7F6E;&#x3002;</p>
<blockquote>
<p>HttpUrlConnectionNetworkFetcher&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x67E5;&#x770B;&#x6E90;&#x7801;&#xFF0C;&#x5185;&#x90E8;&#x5C31;&#x662F;&#x4F7F;&#x7528;HttpUrlConnection&#x8FDB;&#x884C;&#x7F51;&#x7EDC;&#x8D44;&#x6E90;&#x8BF7;&#x6C42;&#x4E0E;&#x89E3;&#x6790;&#x3002;</p>
</blockquote>
<p>&#x5230;&#x8FD9;&#x91CC;&#x6574;&#x4E2A;&#x7684;Producer&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#x5C31;&#x7ED3;&#x675F;&#x4E86;&#xFF0C;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x90FD;&#x4F1A;&#x56DE;&#x5230;&#x5F00;&#x7BC7;&#x5206;&#x6790;&#x7684;Result&#x5904;&#x7406;&#xFF0C;AbstractProducerToDataSourceAdapter&#x4E2D;&#x7684;onNewResultImpl&#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;super.setResult(result, isLast)&#x4F20;&#x9012;&#x7ED3;&#x679C;&#x4E0E;&#x901A;&#x77E5;UI&#x5C42;&#x66F4;&#x65B0;UI&#x3002;</p>
<h2 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h2><p>&#x6700;&#x540E;&#x5BF9;Producer&#x7684;&#x6574;&#x4E2A;&#x8C03;&#x7528;&#x6D41;&#x7A0B;&#x505A;&#x4E2A;&#x603B;&#x7ED3;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x6E90;&#x7801;&#x4E2D;&#x7684;&#x6CE8;&#x91CA;&#x8C03;&#x7528;&#x94FE;&#xFF0C;&#x4E3B;&#x8981;&#x53EF;&#x5212;&#x5206;&#x4E3A;&#x4E09;&#x5927;&#x90E8;&#x5206;&#xFF0C;&#x5206;&#x522B;&#x4E3A;&#xFF1A;<br>swallow result if prefetch -&gt; bitmap cache get -&gt;<br>background thread hand-off -&gt; multiplex -&gt; bitmap cache -&gt; decode -&gt; multiplex -&gt;<br>encoded cache -&gt; disk cache -&gt; (webp transcode) -&gt; network fetch<br>&#x5206;&#x522B;&#x5BF9;&#x5E94;Bitmap&#x7F13;&#x5B58;&#x83B7;&#x53D6;&#x3001;&#x56FE;&#x7247;&#x89E3;&#x7801;&#x3001;&#x672A;&#x89E3;&#x7801;&#x56FE;&#x7247;&#x7F13;&#x5B58;&#x83B7;&#x53D6;&#x3001;&#x78C1;&#x76D8;&#x7F13;&#x5B58;&#x83B7;&#x53D6;&#x4E0E;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x83B7;&#x53D6;&#x3002;</p>

    
  </div>
</article>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">赞赏是一门艺术</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/images/rouse_wechat.png" alt="">
          </li>
        
          <li class="item">
            <img src="/images/rouse_alipay.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2017/12/14/Fresco源码分析之Controller/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2018/02/27/EventBus的工作原理总结/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              rel="noopener noreferrer"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
    <div class="fexo-comments comments-post">
  

  

  

  
  <div id="gitment-comments"></div>
  <link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
  <script src="https://jjeejj.github.io/js/gitment.js"></script>
  <script>
    (function () {
      var gitment = new Gitment({
        owner: 'idisfkj',
        repo: 'idisfkj.github.io',
        id: 'Thu Dec 28 2017 23:45:36 GMT+0800',
        oauth: {
          client_id: 'dafb1df02ea9f875bb78',
          client_secret: 'e9873d78aa5eaed5ce61d1d865a5af501dae377a'
        },
        
        
        
        
        
        
        
        
      })
      gitment.render('gitment-comments')
    })()
  </script>

  
  
</div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
